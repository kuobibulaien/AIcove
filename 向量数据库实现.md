## 向量记忆库整体方案

### 1. 总体架构
- 云端部署 Milvus（或 Milvus Lite+持久盘）+ 记忆服务（FastAPI/Python 复用 Mnemosyne 代码）+ 嵌入服务（CLIP/SigLIP）。
- 客户端仅调用 HTTPS API，不直接连 Milvus，保证 KISS、SOLID。

### 2. Milvus 结构
- Collection：`user_memories`，向量字段 `embedding`（float32, dim=1536），索引 IVF_FLAT+cosine。
- Partition 以 `user_id` 划分，记录字段包含 `role_id`、`conversation_id`、`summary`、`raw_text`、`image_refs`、`importance`、`created_at`、`source`。
- 按 `user_id` 分区+`role_id` 过滤实现账号+角色隔离。

### 3. 嵌入与写入流程
1. `POST /memory/record` 收到 `user_id`、`role_id`、`messages[]`。
2. 用和 Mnemosyne 相同的总结 prompt 压缩多条消息，遵循单一职责。
3. 调嵌入模型生成向量，写入 Milvus 对应 partition，并在 Mongo/Redis 备份元数据。
4. 若未达到阈值，返回 `{"status":"pending","remain":3}`，YAGNI 避免无意义数据。

### 4. 激活阈值逻辑
- Redis 维护 `memory_state[user_id:role_id] = {count, first_timestamp, is_enabled}`。
- 每次 `record` 更新计数；达到 `min_messages` 且满足 `min_minutes` 才写入 Milvus，并把 `is_enabled` 置 true。
- 长期无对话（如 7 天）自动重置，参数可按角色配置。

### 5. API 设计
1. `GET /memory/status?role_id` → 返回 `is_enabled`、`messages_sent`、`remain_to_activate`。
2. `POST /memory/query`：
   ```json
   {"user_id":"u1","role_id":"gf","query_text":"我们上次约会聊了什么","top_k":4}
   ```
   服务器嵌入→Milvus 检索→返回 `[{"summary":"...","raw_text":"...","created_at":...}]`，未启用时返回空数组+`is_enabled:false`。
3. `POST /memory/record`：
   ```json
   {"user_id":"u1","role_id":"gf","messages":[{"speaker":"user","text":"...","images":[]},{"speaker":"ai","text":"..."}]}
   ```
   未达阈值返回 `pending`，达标后总结+嵌入+写入，返回 `{"status":"stored","memory_id":"...","is_enabled":true}`。
4. 可选 `POST /memory/reset` 用于调试或清理。

### 6. 安全与多租户
- 所有请求必须带用户 token，后端解析 `user_id`，禁止客户端自填。
- Milvus 仅对记忆服务开放；写入前可加密敏感文本。
- 定期备份：Milvus Dump + Mongo/Redis snapshot，接口与备份脚本解耦（SOLID）。

### 7. 部署步骤
1. 安装 Milvus，创建 `user_memories` collection 与 partition 规则。
2. 抽离 Mnemosyne `memory_manager` 代码做 FastAPI 服务：包含 `EmbeddingService`、`MilvusManager`、`ContextManager`。
3. 实现 `status/query/record/reset` 接口并部署 HTTPS，Nginx/WAF 做鉴权与限流。
4. Flutter 端实现 `MemoryService`：封装 API 调用，处理 `pending/stored` 状态，缓存查询结果 5 分钟。
5. 编写自动化测试：未激活→激活→多角色并行→安全校验。

### 8. 扩展计划
- 增加情绪/话题标签字段，支持情绪过滤。
- 定期清理或压缩旧记忆，保持 Milvus 容量。
- 多模态：当消息包含图片时生成 `image_embedding` 并扩展字段，保持结构可扩展。
