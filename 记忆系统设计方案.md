# MyGril 分层记忆系统设计方案

## 1. 核心理念
**本地优先 (Local-First)** + **云端同步 (Cloud-Sync)**。
利用手机终端算力进行向量检索，保护隐私且零延迟；云端仅作为数据备份和多端同步的存储库。

## 2. 架构分层

### L1: 短期记忆 (Context Window)
- **定义**: 当前会话的最近 N 轮对话。
- **存储**: 现有的 Message 表 (SQLite)。
- **用途**: 直接作为 LLM 的 Context 输入。

### L2: 长期记忆 (Vector Store)
- **定义**: 经过 LLM 提炼的关键事实、用户喜好、重要经历。
- **结构**: `MemoryEntity`
  - `id`: UUID
  - `content`: 文本内容 (e.g., "用户不喜欢吃香菜")
  - `embedding`: 向量数据 `List<double>` (e.g., `[0.12, -0.5, ...]`)
  - `sourceMessageId`: 来源消息ID (可溯源)
  - `importance`: 重要性权重 (1-10)
  - `createdAt`: 创建时间
  - `lastAccessedAt`: 最后访问时间
- **存储**: SQLite (`memories` 表)。向量字段序列化为 JSON 字符串或 Blob 存储。
- **检索**: 内存中计算余弦相似度 (Cosine Similarity)。对于 < 10,000 条记录，Dart 性能足够。

### L3: 嵌入服务 (Embedding Service)
- **接口**: `EmbeddingService`
- **实现**: `OpenAIEmbeddingService` (兼容 OpenAI API 格式)
- **配置**: 支持自定义 Base URL, Model Name, API Key。

## 3. 详细工作流

### 3.1 记忆形成 (Memory Formation)
1.  **触发**: 对话结束或每隔 N 条消息。
2.  **提炼**: 调用 Chat LLM (如 GPT-4o-mini / Gemini Flash) 分析最近对话。
    -   *Prompt*: "分析对话，提取关于用户的关键事实。忽略闲聊。"
3.  **嵌入**: 调用 `EmbeddingService` 将提炼出的文本转化为向量。
4.  **存储**: 存入 SQLite。

### 3.2 记忆检索 (Retrieval / RAG)
1.  **用户输入**: "我饿了"。
2.  **嵌入**: 将 "我饿了" 转化为向量 $V_{query}$。
3.  **搜索**: 加载所有记忆向量 $V_{mem}$，计算 $Similarity(V_{query}, V_{mem})$。
4.  **排序**: 按相似度降序排列，取 Top K (e.g., 3)。
5.  **注入**: 将 Top K 记忆文本拼接到 System Prompt。

## 4. 目录结构
```
lib/src/features/memory/
├── models/
│   └── memory_entity.dart       # 数据模型
├── services/
│   ├── embedding_service.dart   # 嵌入服务接口
│   ├── openai_embedding_service.dart # OpenAI 实现
│   └── memory_service.dart      # 核心业务逻辑 (CRUD + Search)
└── repositories/
    └── memory_repository.dart   # 数据库操作
```

## 5. 数据库 Schema (SQLite)
```sql
CREATE TABLE memories (
    id TEXT PRIMARY KEY,
    content TEXT NOT NULL,
    embedding TEXT NOT NULL, -- JSON string of List<double>
    importance INTEGER DEFAULT 1,
    created_at INTEGER,
    last_accessed_at INTEGER,
    is_synced INTEGER DEFAULT 0 -- 0: 未同步, 1: 已同步
);
```
