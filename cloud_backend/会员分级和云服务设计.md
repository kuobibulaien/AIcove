# ä¼šå‘˜åˆ†çº§å’Œäº‘æœåŠ¡ç³»ç»Ÿè®¾è®¡

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

å®ç°ä¸€ä¸ªçµæ´»çš„ä¼šå‘˜åˆ†çº§ç³»ç»Ÿï¼Œä¸åŒçº§åˆ«çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸åŒçš„äº‘æœåŠ¡åŠŸèƒ½ã€‚

---

## ğŸ‘¥ è´¦å·åˆ†çº§ç³»ç»Ÿ

### çº§åˆ«å®šä¹‰

| çº§åˆ« | åç§° | åŠŸèƒ½æƒé™ |
|------|------|----------|
| 0 | å…è´¹ç‰ˆ | åŸºç¡€æ•°æ®åŒæ­¥ï¼ˆè”ç³»äººã€æ¶ˆæ¯ã€è®¾ç½®ï¼‰ |
| 1 | åŸºç¡€ç‰ˆ | å…è´¹ç‰ˆ + æ•°æ®å¤‡ä»½ |
| 2 | æ ‡å‡†ç‰ˆ | åŸºç¡€ç‰ˆ + Keyåˆ†å‘ï¼ˆæœ‰é¢åº¦ï¼‰ |
| 3 | é«˜çº§ç‰ˆ | æ ‡å‡†ç‰ˆ + äº‘è§¦å‘å™¨ |
| 4 | ä¸“ä¸šç‰ˆ | é«˜çº§ç‰ˆ + äº‘è®°å¿†åº“ |
| 99 | ç®¡ç†å‘˜ | æ‰€æœ‰åŠŸèƒ½ + åå°ç®¡ç† |

### ç”¨æˆ·æ¨¡å‹æ‰©å±•

```python
class User(Base):
    id = Column(Integer, primary_key=True)
    username = Column(String(100), unique=True)
    email = Column(String(200), unique=True)
    password_hash = Column(String(255))
    
    # æ–°å¢å­—æ®µ
    user_level = Column(Integer, default=0)        # è´¦å·çº§åˆ«
    unique_id = Column(String(50), unique=True)     # å”¯ä¸€IDï¼ˆå¦‚ï¼šUSER-00001ï¼‰
    
    is_admin = Column(Boolean, default=False)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=func.now())
    expires_at = Column(DateTime, nullable=True)    # ä¼šå‘˜åˆ°æœŸæ—¶é—´
```

---

## â˜ï¸ äº‘æœåŠ¡åŠŸèƒ½è¯¦è§£

### 1ï¸âƒ£ æ•°æ®å¤‡ä»½ï¼ˆLevel 1+ï¼‰

**åŠŸèƒ½ï¼š**
- å®šæœŸè‡ªåŠ¨å¤‡ä»½ç”¨æˆ·æ•°æ®
- æ”¯æŒæ‰‹åŠ¨è§¦å‘å¤‡ä»½
- ä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
- å¯æ¢å¤åˆ°ä»»æ„å¤‡ä»½ç‚¹

**æ•°æ®åº“è¡¨ï¼š**
```python
class DataBackup(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'))
    backup_type = Column(String(50))  # 'auto' / 'manual'
    backup_data = Column(Text)        # JSONæ ¼å¼çš„å®Œæ•´æ•°æ®
    created_at = Column(DateTime, default=func.now())
    file_size = Column(Integer)       # å¤‡ä»½å¤§å°ï¼ˆå­—èŠ‚ï¼‰
```

**APIç«¯ç‚¹ï¼š**
```
POST /api/v1/backup/create          # åˆ›å»ºå¤‡ä»½
GET  /api/v1/backup/list            # å¤‡ä»½åˆ—è¡¨
POST /api/v1/backup/{id}/restore    # æ¢å¤å¤‡ä»½
DELETE /api/v1/backup/{id}          # åˆ é™¤å¤‡ä»½
```

---

### 2ï¸âƒ£ Keyåˆ†å‘ï¼ˆLevel 2+ï¼‰

**åŠŸèƒ½ï¼š**
- ç®¡ç†å‘˜åœ¨åå°ç»Ÿä¸€ç®¡ç†API Keys
- ç”¨æˆ·æ— éœ€è‡ªå·±æä¾›Key
- æ¯ä¸ªç”¨æˆ·æœ‰è°ƒç”¨é¢åº¦
- æ”¯æŒå¤šä¸ªProviderï¼ˆOpenAIã€Geminiç­‰ï¼‰
- é¢åº¦ç”¨å®Œè‡ªåŠ¨ç¦ç”¨

**æ•°æ®åº“è¡¨ï¼š**
```python
# ç®¡ç†å‘˜é…ç½®çš„Keyæ± 
class ApiKeyPool(Base):
    id = Column(Integer, primary_key=True)
    provider = Column(String(50))     # 'openai', 'gemini'
    api_key_encrypted = Column(Text)  # åŠ å¯†çš„Key
    quota_total = Column(Integer)     # æ€»é¢åº¦ï¼ˆå¦‚ï¼š1000000 tokensï¼‰
    quota_used = Column(Integer, default=0)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=func.now())

# ç”¨æˆ·é¢åº¦åˆ†é…
class UserQuota(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'))
    provider = Column(String(50))
    quota_total = Column(Integer)     # åˆ†é…çš„æ€»é¢åº¦
    quota_used = Column(Integer, default=0)
    quota_reset_at = Column(DateTime) # é¢åº¦é‡ç½®æ—¶é—´
    created_at = Column(DateTime, default=func.now())

# ä½¿ç”¨è®°å½•
class QuotaUsageLog(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'))
    provider = Column(String(50))
    tokens_used = Column(Integer)
    request_id = Column(String(100))
    created_at = Column(DateTime, default=func.now())
```

**APIç«¯ç‚¹ï¼š**
```
# ç”¨æˆ·ç«¯
GET  /api/v1/keys/available        # è·å–å¯ç”¨çš„Provideråˆ—è¡¨
POST /api/v1/keys/request          # è¯·æ±‚Keyï¼ˆè¿”å›ä¸´æ—¶Keyæˆ–ä»£ç†ï¼‰
GET  /api/v1/keys/quota            # æŸ¥çœ‹è‡ªå·±çš„é¢åº¦

# ç®¡ç†å‘˜ç«¯
POST /api/v1/admin/keys/pool       # æ·»åŠ Keyåˆ°æ± ä¸­
GET  /api/v1/admin/keys/pool       # Keyæ± åˆ—è¡¨
POST /api/v1/admin/keys/assign     # ç»™ç”¨æˆ·åˆ†é…é¢åº¦
GET  /api/v1/admin/keys/usage      # æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡
```

**å·¥ä½œæµç¨‹ï¼š**
```
1. ç®¡ç†å‘˜æ·»åŠ Keyåˆ°æ± ä¸­ï¼š
   - Provider: OpenAI
   - Key: sk-xxx...
   - æ€»é¢åº¦: 1000000 tokens

2. ç®¡ç†å‘˜ç»™ç”¨æˆ·åˆ†é…é¢åº¦ï¼š
   - ç”¨æˆ·: USER-00001
   - Provider: OpenAI
   - é¢åº¦: 10000 tokens/æœˆ

3. ç”¨æˆ·è¯·æ±‚Keyï¼š
   - Flutter â†’ POST /api/v1/keys/request {provider: "openai"}
   - åç«¯ â†’ æ£€æŸ¥é¢åº¦ â†’ è¿”å›ä¸´æ—¶Keyæˆ–ä»£ç†URL
   
4. ç”¨æˆ·ä½¿ç”¨Keyï¼š
   - Flutter â†’ è°ƒç”¨OpenAI API
   - åç«¯ â†’ è®°å½•ä½¿ç”¨é‡ â†’ æ‰£é™¤é¢åº¦

5. é¢åº¦è€—å°½ï¼š
   - ç”¨æˆ·è¯·æ±‚Keyæ—¶è¿”å›"é¢åº¦ä¸è¶³"
   - ä¸‹æœˆ1æ—¥è‡ªåŠ¨é‡ç½®é¢åº¦
```

---

### 3ï¸âƒ£ äº‘è§¦å‘å™¨ï¼ˆLevel 3+ï¼‰

**åŠŸèƒ½ï¼š**
- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©æ—©ä¸Š8ç‚¹å‘é€é—®å€™ï¼‰
- æ¡ä»¶è§¦å‘ï¼ˆç”¨æˆ·è¿ç»­3å¤©æœªä½¿ç”¨ï¼Œå‘é€å…³å¿ƒæ¶ˆæ¯ï¼‰
- äº‹ä»¶è§¦å‘ï¼ˆç”¨æˆ·ç”Ÿæ—¥è‡ªåŠ¨å‘é€ç¥ç¦ï¼‰
- Webhookè§¦å‘ï¼ˆå¤–éƒ¨ç³»ç»Ÿè§¦å‘ï¼‰

**æ•°æ®åº“è¡¨ï¼š**
```python
class CloudTrigger(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'))
    trigger_name = Column(String(200))
    trigger_type = Column(String(50))  # 'schedule', 'condition', 'event', 'webhook'
    trigger_config = Column(Text)      # JSONé…ç½®
    action_type = Column(String(50))   # 'send_message', 'call_api', 'webhook'
    action_config = Column(Text)       # JSONé…ç½®
    is_active = Column(Boolean, default=True)
    last_triggered_at = Column(DateTime)
    created_at = Column(DateTime, default=func.now())

class TriggerLog(Base):
    id = Column(Integer, primary_key=True)
    trigger_id = Column(Integer, ForeignKey('cloud_triggers.id'))
    status = Column(String(50))        # 'success', 'failed'
    result = Column(Text)              # æ‰§è¡Œç»“æœ
    created_at = Column(DateTime, default=func.now())
```

**APIç«¯ç‚¹ï¼š**
```
POST /api/v1/triggers/create       # åˆ›å»ºè§¦å‘å™¨
GET  /api/v1/triggers/list         # è§¦å‘å™¨åˆ—è¡¨
PUT  /api/v1/triggers/{id}         # æ›´æ–°è§¦å‘å™¨
DELETE /api/v1/triggers/{id}       # åˆ é™¤è§¦å‘å™¨
POST /api/v1/triggers/{id}/test    # æµ‹è¯•è§¦å‘å™¨
GET  /api/v1/triggers/{id}/logs    # æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
```

**é…ç½®ç¤ºä¾‹ï¼š**
```json
// å®šæ—¶è§¦å‘å™¨ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹å‘é€é—®å€™
{
  "trigger_type": "schedule",
  "trigger_config": {
    "cron": "0 8 * * *",
    "timezone": "Asia/Shanghai"
  },
  "action_type": "send_message",
  "action_config": {
    "contact_id": "uuid-123",
    "template": "æ—©å®‰ï¼ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å“¦~"
  }
}

// æ¡ä»¶è§¦å‘å™¨ï¼š3å¤©æœªä½¿ç”¨
{
  "trigger_type": "condition",
  "trigger_config": {
    "check_interval": "1h",
    "condition": "last_message_time > 72h"
  },
  "action_type": "send_message",
  "action_config": {
    "contact_id": "uuid-123",
    "template": "å¥½ä¹…ä¸è§ï¼Œæœ€è¿‘è¿˜å¥½å—ï¼Ÿ"
  }
}
```

---

### 4ï¸âƒ£ äº‘è®°å¿†åº“ï¼ˆLevel 4+ï¼‰

**åŠŸèƒ½ï¼š**
- å‘é‡æ•°æ®åº“å­˜å‚¨å¯¹è¯è®°å¿†
- æ™ºèƒ½æ£€ç´¢ç›¸å…³å†å²
- å¤šè®¾å¤‡å…±äº«è®°å¿†
- é•¿æœŸè®°å¿†ç®¡ç†

**æ•°æ®åº“è¡¨ï¼š**
```python
class MemoryEntry(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'))
    contact_id = Column(String(100))
    memory_type = Column(String(50))   # 'fact', 'preference', 'event'
    content = Column(Text)
    embedding = Column(Text)           # å‘é‡ï¼ˆJSONæ ¼å¼ï¼‰
    importance = Column(Integer)       # é‡è¦æ€§ 1-10
    created_at = Column(DateTime, default=func.now())
    accessed_count = Column(Integer, default=0)
    last_accessed_at = Column(DateTime)

class MemoryTag(Base):
    id = Column(Integer, primary_key=True)
    memory_id = Column(Integer, ForeignKey('memory_entries.id'))
    tag = Column(String(100))
```

**APIç«¯ç‚¹ï¼š**
```
POST /api/v1/memory/store          # å­˜å‚¨è®°å¿†
GET  /api/v1/memory/search         # æœç´¢ç›¸å…³è®°å¿†
GET  /api/v1/memory/list           # è®°å¿†åˆ—è¡¨
PUT  /api/v1/memory/{id}           # æ›´æ–°è®°å¿†
DELETE /api/v1/memory/{id}         # åˆ é™¤è®°å¿†
POST /api/v1/memory/embed          # ç”Ÿæˆå‘é‡ï¼ˆè°ƒç”¨AIï¼‰
```

**ä½¿ç”¨æµç¨‹ï¼š**
```
1. ç”¨æˆ·èŠå¤©æ—¶ï¼š
   - Flutter â†’ å‘é€æ¶ˆæ¯
   - åç«¯ â†’ æå–å…³é”®ä¿¡æ¯ â†’ å­˜å‚¨åˆ°è®°å¿†åº“
   
2. ä¸‹æ¬¡å¯¹è¯æ—¶ï¼š
   - Flutter â†’ å‘é€æ–°æ¶ˆæ¯
   - åç«¯ â†’ å‘é‡æœç´¢ç›¸å…³è®°å¿†
   - åç«¯ â†’ å°†ç›¸å…³è®°å¿†æ³¨å…¥System Prompt
   - AI â†’ ç”Ÿæˆå›å¤ï¼ˆå¸¦æœ‰å†å²è®°å¿†ï¼‰
```

---

## ğŸ” æƒé™æ§åˆ¶ç³»ç»Ÿ

### æƒé™æ£€æŸ¥è£…é¥°å™¨

```python
from functools import wraps

def require_level(min_level: int):
    """è¦æ±‚æœ€ä½ç”¨æˆ·çº§åˆ«"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            user_id = kwargs.get('user_id')
            db = kwargs.get('db')
            
            user = db.query(User).filter(User.id == user_id).first()
            if user.user_level < min_level:
                raise HTTPException(
                    status_code=403,
                    detail=f"æ­¤åŠŸèƒ½éœ€è¦Level {min_level}åŠä»¥ä¸Šä¼šå‘˜"
                )
            
            return await func(*args, **kwargs)
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@router.post("/backup/create")
@require_level(1)  # éœ€è¦Level 1
async def create_backup(
    user_id: int = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # åˆ›å»ºå¤‡ä»½é€»è¾‘
    pass
```

---

## ğŸ“Š ç®¡ç†åå°æ‰©å±•

### æ–°å¢ç®¡ç†åŠŸèƒ½

#### 1. ç”¨æˆ·çº§åˆ«ç®¡ç†
```
GET  /api/v1/admin/users/{id}/level     # æŸ¥çœ‹ç”¨æˆ·çº§åˆ«
PUT  /api/v1/admin/users/{id}/level     # ä¿®æ”¹ç”¨æˆ·çº§åˆ«
POST /api/v1/admin/users/{id}/upgrade   # å‡çº§ç”¨æˆ·
```

#### 2. é¢åº¦ç®¡ç†
```
GET  /api/v1/admin/quota/overview       # é¢åº¦ä½¿ç”¨æ¦‚è§ˆ
POST /api/v1/admin/quota/batch-assign   # æ‰¹é‡åˆ†é…é¢åº¦
GET  /api/v1/admin/quota/logs           # ä½¿ç”¨æ—¥å¿—
```

#### 3. æœåŠ¡ç›‘æ§
```
GET  /api/v1/admin/services/status      # å„äº‘æœåŠ¡çŠ¶æ€
GET  /api/v1/admin/services/stats       # ä½¿ç”¨ç»Ÿè®¡
```

---

## ğŸ’° å®šä»·ç­–ç•¥ï¼ˆç¤ºä¾‹ï¼‰

| çº§åˆ« | æœˆè´¹ | åŠŸèƒ½ |
|------|------|------|
| å…è´¹ç‰ˆ | Â¥0 | åŸºç¡€åŒæ­¥ï¼ˆ5ä¸ªè”ç³»äººï¼Œ1000æ¡æ¶ˆæ¯ï¼‰ |
| åŸºç¡€ç‰ˆ | Â¥9.9 | + æ•°æ®å¤‡ä»½ï¼ˆæ— é™è”ç³»äººå’Œæ¶ˆæ¯ï¼‰ |
| æ ‡å‡†ç‰ˆ | Â¥29.9 | + Keyåˆ†å‘ï¼ˆ10ä¸‡tokens/æœˆï¼‰ |
| é«˜çº§ç‰ˆ | Â¥59.9 | + äº‘è§¦å‘å™¨ï¼ˆ10ä¸ªè§¦å‘å™¨ï¼‰ |
| ä¸“ä¸šç‰ˆ | Â¥99.9 | + äº‘è®°å¿†åº“ï¼ˆæ— é™è®°å¿†ï¼‰ |

---

## ğŸ”„ å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ¶æ„ï¼ˆ1-2å¤©ï¼‰
- [x] æ‰©å±•Useræ¨¡å‹ï¼ˆæ·»åŠ user_levelç­‰ï¼‰
- [ ] å®ç°æƒé™æ£€æŸ¥ç³»ç»Ÿ
- [ ] æ›´æ–°æ³¨å†Œæµç¨‹ï¼ˆåˆ†é…unique_idï¼‰

### Phase 2: Keyåˆ†å‘ç³»ç»Ÿï¼ˆ2-3å¤©ï¼‰
- [ ] åˆ›å»ºKeyæ± è¡¨ç»“æ„
- [ ] å®ç°Keyåˆ†é…é€»è¾‘
- [ ] å®ç°é¢åº¦ç®¡ç†
- [ ] åˆ›å»ºä½¿ç”¨ç»Ÿè®¡

### Phase 3: æ•°æ®å¤‡ä»½ï¼ˆ1å¤©ï¼‰
- [ ] å®ç°å¤‡ä»½åˆ›å»º
- [ ] å®ç°å¤‡ä»½æ¢å¤
- [ ] å®ç°å®šæœŸæ¸…ç†

### Phase 4: äº‘è§¦å‘å™¨ï¼ˆ3-4å¤©ï¼‰
- [ ] å®šæ—¶è§¦å‘å™¨
- [ ] æ¡ä»¶è§¦å‘å™¨
- [ ] Webhookè§¦å‘å™¨
- [ ] æ‰§è¡Œæ—¥å¿—

### Phase 5: äº‘è®°å¿†åº“ï¼ˆ3-4å¤©ï¼‰
- [ ] å‘é‡å­˜å‚¨
- [ ] è®°å¿†æ£€ç´¢
- [ ] è®°å¿†ç®¡ç†API

### Phase 6: ç®¡ç†åå°ï¼ˆ2-3å¤©ï¼‰
- [ ] ç”¨æˆ·çº§åˆ«ç®¡ç†ç•Œé¢
- [ ] é¢åº¦ç®¡ç†ç•Œé¢
- [ ] æœåŠ¡ç›‘æ§ç•Œé¢

---

## ğŸ“ æ•°æ®è¿ç§»

### ç°æœ‰ç”¨æˆ·è¿ç§»
```python
# å°†ç°æœ‰ç”¨æˆ·è®¾ä¸ºLevel 0ï¼ˆå…è´¹ç‰ˆï¼‰
db.query(User).update({User.user_level: 0})

# ç”Ÿæˆunique_id
for user in db.query(User).all():
    user.unique_id = f"USER-{user.id:05d}"
db.commit()
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶

### .env æ–°å¢é…ç½®
```env
# Keyåˆ†å‘é…ç½®
KEY_DISTRIBUTION_ENABLED=true
DEFAULT_QUOTA_MONTHLY=10000  # é»˜è®¤æœˆé¢åº¦

# äº‘è§¦å‘å™¨é…ç½®
TRIGGER_ENABLED=true
TRIGGER_CHECK_INTERVAL=60  # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰

# äº‘è®°å¿†åº“é…ç½®
MEMORY_ENABLED=true
EMBEDDING_PROVIDER=openai
EMBEDDING_MODEL=text-embedding-ada-002
```

---

## ğŸ“š Flutterç«¯é›†æˆ

### æ£€æŸ¥ç”¨æˆ·çº§åˆ«
```dart
final user = await apiClient.getCurrentUser();
if (user.userLevel >= 2) {
  // æ˜¾ç¤ºKeyåˆ†å‘åŠŸèƒ½
}
```

### ä½¿ç”¨Keyåˆ†å‘
```dart
// è¯·æ±‚Key
final keyResponse = await apiClient.requestKey(provider: 'openai');

// ä½¿ç”¨Keyè°ƒç”¨OpenAI
final openai = OpenAI(apiKey: keyResponse.key);
```

---

## ğŸ¯ æ€»ç»“

è¿™å¥—ç³»ç»Ÿæä¾›äº†ï¼š
- âœ… çµæ´»çš„ä¼šå‘˜åˆ†çº§
- âœ… å¼ºå¤§çš„äº‘æœåŠ¡åŠŸèƒ½
- âœ… å®Œå–„çš„é¢åº¦ç®¡ç†
- âœ… ä¾¿æ·çš„ç®¡ç†åå°

å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´çº§åˆ«æƒé™å’ŒåŠŸèƒ½ç»„åˆã€‚
