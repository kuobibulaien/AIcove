# Cloud Backend åŠŸèƒ½è¯¦è§£ï¼ˆå°ç™½ç‰ˆï¼‰

## ğŸ¯ è¿™ä¸ªåç«¯æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ

**ä¸€å¥è¯æ€»ç»“ï¼š** è¿™æ˜¯ä¸€ä¸ªæç®€çš„äº‘å­˜å‚¨æœåŠ¡å™¨ï¼Œåªè´Ÿè´£3ä»¶äº‹ï¼š
1. **ç®¡ç†è´¦å·**ï¼šç”¨æˆ·æ³¨å†Œã€ç™»å½•
2. **å­˜å‚¨æ•°æ®**ï¼šä¿å­˜ä½ çš„èŠå¤©è®°å½•ã€è§’è‰²ä¿¡æ¯
3. **åŒæ­¥æ•°æ®**ï¼šè®©ä½ åœ¨ä¸åŒè®¾å¤‡ä¸Šçœ‹åˆ°åŒæ ·çš„æ•°æ®

**å®ƒä¸åšä»€ä¹ˆï¼š**
- âŒ ä¸è´Ÿè´£AIå¯¹è¯ï¼ˆè¿™ä¸ªåœ¨Flutterå®¢æˆ·ç«¯åšï¼‰
- âŒ ä¸è°ƒç”¨OpenAI/Geminiï¼ˆè¿™ä¸ªåœ¨Flutterå®¢æˆ·ç«¯åšï¼‰
- âŒ ä¸å¤„ç†è¯­éŸ³ï¼ˆè¿™ä¸ªåœ¨Flutterå®¢æˆ·ç«¯åšï¼‰

---

## ğŸ“ æ–‡ä»¶ç»“æ„ï¼ˆæ¯ä¸ªæ–‡ä»¶éƒ½å¹²å•¥ï¼‰

```
cloud_backend/
â”œâ”€â”€ main.py              # ğŸšª å…¥å£æ–‡ä»¶ï¼šå¯åŠ¨æœåŠ¡å™¨
â”œâ”€â”€ auth.py              # ğŸ” è®¤è¯æ¨¡å—ï¼šæ³¨å†Œã€ç™»å½•ã€éªŒè¯èº«ä»½
â”œâ”€â”€ sync_api.py          # â˜ï¸ åŒæ­¥APIï¼šä¸Šä¼ ä¸‹è½½æ•°æ®
â”œâ”€â”€ admin_api.py         # ğŸ‘‘ ç®¡ç†åå°ï¼šç®¡ç†ç”¨æˆ·å’Œé‚€è¯·ç 
â”œâ”€â”€ models.py            # ğŸ“Š æ•°æ®æ¨¡å‹ï¼šå®šä¹‰æ•°æ®åº“è¡¨ç»“æ„
â”œâ”€â”€ database.py          # ğŸ—„ï¸ æ•°æ®åº“è¿æ¥ï¼šè¿æ¥SQLiteæ•°æ®åº“
â”œâ”€â”€ requirements.txt     # ğŸ“¦ ä¾èµ–åˆ—è¡¨ï¼šéœ€è¦å®‰è£…çš„PythonåŒ…
â”œâ”€â”€ .env.example         # âš™ï¸ é…ç½®æ¨¡æ¿ï¼šç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ Dockerfile           # ğŸ³ Dockeré•œåƒé…ç½®
â”œâ”€â”€ docker-compose.yml   # ğŸ³ Dockerç¼–æ’é…ç½®
â”œâ”€â”€ start.sh             # ğŸš€ Linuxå¯åŠ¨è„šæœ¬
â”œâ”€â”€ start.ps1            # ğŸš€ Windowså¯åŠ¨è„šæœ¬
â””â”€â”€ README.md            # ğŸ“– ä½¿ç”¨æ–‡æ¡£
```

---

## ğŸ” è¯¦ç»†åŠŸèƒ½è¯´æ˜

### 1ï¸âƒ£ main.py - æœåŠ¡å™¨å…¥å£

**ä½œç”¨ï¼š** å¯åŠ¨WebæœåŠ¡å™¨ï¼ŒæŠŠæ‰€æœ‰åŠŸèƒ½è¿æ¥èµ·æ¥

**ä»£ç ç»“æ„ï¼š**
```python
from fastapi import FastAPI

app = FastAPI()  # åˆ›å»ºæœåŠ¡å™¨åº”ç”¨

# æ³¨å†Œå„ä¸ªåŠŸèƒ½æ¨¡å—
app.include_router(auth_router)      # è®¤è¯åŠŸèƒ½
app.include_router(sync_router)      # åŒæ­¥åŠŸèƒ½
app.include_router(admin_router)     # ç®¡ç†åŠŸèƒ½

# æ ¹è·¯å¾„ï¼ˆè®¿é—®é¦–é¡µï¼‰
@app.get("/")
def root():
    return {"service": "MyGril Cloud Sync"}

# å¥åº·æ£€æŸ¥ï¼ˆæ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼‰
@app.get("/health")
def health():
    return {"status": "ok"}
```

**ä½ è®¿é—®åç«¯æ—¶ï¼š**
- `http://localhost:8000/` â†’ æ˜¾ç¤ºæœåŠ¡ä¿¡æ¯
- `http://localhost:8000/health` â†’ æ˜¾ç¤º"ok"ï¼ˆæœåŠ¡æ­£å¸¸ï¼‰
- `http://localhost:8000/docs` â†’ æ˜¾ç¤ºAPIæ–‡æ¡£ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

---

### 2ï¸âƒ£ auth.py - è®¤è¯æ¨¡å—

**ä½œç”¨ï¼š** ç®¡ç†ç”¨æˆ·è´¦å·ï¼ŒéªŒè¯èº«ä»½

#### åŠŸèƒ½åˆ—è¡¨ï¼š

##### ğŸ“ æ³¨å†Œæ–°è´¦å·
```
POST /api/v1/auth/register

è¯·æ±‚æ•°æ®ï¼š
{
  "username": "å¼ ä¸‰",
  "password": "123456",
  "email": "zhangsan@example.com",
  "invite_code": "ABC123"  // å¯é€‰
}

è¿”å›æ•°æ®ï¼š
{
  "access_token": "eyJhbGc...",  // ç™»å½•å‡­è¯
  "user": {
    "id": 1,
    "username": "å¼ ä¸‰",
    "email": "zhangsan@example.com"
  }
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
2. æ£€æŸ¥é‚€è¯·ç æ˜¯å¦æœ‰æ•ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
3. åŠ å¯†å¯†ç ï¼ˆç”¨BcryptåŠ å¯†ï¼Œä¸ä¼šæ˜æ–‡å­˜å‚¨ï¼‰
4. ä¿å­˜åˆ°æ•°æ®åº“
5. ç”Ÿæˆç™»å½•Tokenï¼ˆJWTï¼‰

##### ğŸ”‘ ç™»å½•è´¦å·
```
POST /api/v1/auth/login

è¯·æ±‚æ•°æ®ï¼š
{
  "username": "å¼ ä¸‰",
  "password": "123456"
}

è¿”å›æ•°æ®ï¼š
{
  "access_token": "eyJhbGc...",
  "user": { ... }
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
1. æŸ¥æ‰¾ç”¨æˆ·
2. éªŒè¯å¯†ç 
3. ç”ŸæˆTokenï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰

##### ğŸ‘¤ è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
```
GET /api/v1/auth/me
Headers: Authorization: Bearer eyJhbGc...

è¿”å›æ•°æ®ï¼š
{
  "id": 1,
  "username": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  "is_admin": false
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
1. ä»Tokenä¸­è§£æç”¨æˆ·ID
2. ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
3. è¿”å›ç”¨æˆ·æ•°æ®

##### ğŸ‘‘ åˆ›å»ºé¦–ä¸ªç®¡ç†å‘˜
```
POST /api/v1/auth/bootstrap-admin

è¯·æ±‚æ•°æ®ï¼š
{
  "username": "admin",
  "password": "admin123"
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²æœ‰ç”¨æˆ·ï¼ˆå¦‚æœæœ‰å°±æ‹’ç»ï¼‰
2. åˆ›å»ºç®¡ç†å‘˜è´¦å·
3. è®¾ç½®is_admin=true

---

### 3ï¸âƒ£ sync_api.py - æ•°æ®åŒæ­¥

**ä½œç”¨ï¼š** åœ¨äº‘ç«¯å’Œæœ¬åœ°ä¹‹é—´åŒæ­¥æ•°æ®

#### åŠŸèƒ½åˆ—è¡¨ï¼š

##### ğŸ“‡ è”ç³»äººåŒæ­¥

**è·å–æ‰€æœ‰è”ç³»äººï¼š**
```
GET /api/v1/sync/contacts
Headers: Authorization: Bearer xxx

è¿”å›æ•°æ®ï¼š
{
  "contacts": [
    {
      "contact_id": "uuid-123",
      "name": "å°ç¾",
      "avatar_url": "https://...",
      "character_data": {
        "system_prompt": "ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”çš„å¥³å‹...",
        "personality": "æ¸©æŸ”"
      },
      "updated_at": "2025-01-14T10:00:00Z"
    }
  ],
  "count": 1
}
```

**æ‰¹é‡ä¸Šä¼ è”ç³»äººï¼š**
```
POST /api/v1/sync/contacts

è¯·æ±‚æ•°æ®ï¼š
{
  "items": [
    {
      "contact_id": "uuid-123",
      "name": "å°ç¾",
      "avatar_url": "https://...",
      "character_data": { ... },
      "updated_at": "2025-01-14T10:00:00Z"
    }
  ]
}

è¿”å›æ•°æ®ï¼š
{
  "synced": 1,           // æˆåŠŸåŒæ­¥çš„æ•°é‡
  "conflicts": [],       // å†²çªåˆ—è¡¨ï¼ˆå¦‚æœæœ‰ï¼‰
  "errors": []           // é”™è¯¯åˆ—è¡¨
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
1. éå†æ¯ä¸ªè”ç³»äºº
2. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆç”¨contact_idåˆ¤æ–­ï¼‰
3. å¦‚æœå­˜åœ¨ï¼š
   - æ¯”è¾ƒupdated_atæ—¶é—´æˆ³
   - å¦‚æœæœåŠ¡å™¨ç‰ˆæœ¬æ›´æ–°ï¼ŒæŠ¥å‘Šå†²çª
   - å¦åˆ™æ›´æ–°æ•°æ®
4. å¦‚æœä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°è®°å½•

##### ğŸ’¬ æ¶ˆæ¯åŒæ­¥

**è·å–æ¶ˆæ¯ï¼š**
```
GET /api/v1/sync/messages?contact_id=uuid-123&since=2025-01-14T10:00:00Z

è¿”å›æ•°æ®ï¼š
{
  "messages": [
    {
      "message_id": "msg-456",
      "contact_id": "uuid-123",
      "role": "user",          // ç”¨æˆ·æ¶ˆæ¯
      "content": "ä½ å¥½",
      "created_at": "2025-01-14T10:05:00Z"
    },
    {
      "message_id": "msg-457",
      "contact_id": "uuid-123",
      "role": "assistant",     // AIå›å¤
      "content": "ä½ å¥½å‘€~",
      "created_at": "2025-01-14T10:05:10Z"
    }
  ],
  "count": 2,
  "has_more": false
}
```

**æ‰¹é‡ä¸Šä¼ æ¶ˆæ¯ï¼š**
```
POST /api/v1/sync/messages

è¯·æ±‚æ•°æ®ï¼š
{
  "items": [
    {
      "message_id": "msg-456",
      "contact_id": "uuid-123",
      "role": "user",
      "content": "ä½ å¥½",
      "created_at": "2025-01-14T10:05:00Z"
    }
  ]
}

è¿”å›æ•°æ®ï¼š
{
  "synced": 1,      // æˆåŠŸä¸Šä¼ çš„æ•°é‡
  "skipped": 0,     // å·²å­˜åœ¨çš„ï¼ˆè·³è¿‡ï¼‰
  "errors": []
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
1. æ£€æŸ¥æ¯æ¡æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆç”¨message_idï¼‰
2. å·²å­˜åœ¨çš„è·³è¿‡ï¼ˆé¿å…é‡å¤ï¼‰
3. æ–°æ¶ˆæ¯æ’å…¥æ•°æ®åº“

##### âš™ï¸ è®¾ç½®åŒæ­¥

**è·å–è®¾ç½®ï¼š**
```
GET /api/v1/sync/settings

è¿”å›æ•°æ®ï¼š
{
  "settings": {
    "theme": "dark",
    "auto_play_tts": true,
    "default_provider": "openai"
  },
  "updated_at": "2025-01-14T09:00:00Z"
}
```

**æ›´æ–°è®¾ç½®ï¼š**
```
PUT /api/v1/sync/settings

è¯·æ±‚æ•°æ®ï¼š
{
  "settings": {
    "theme": "dark",
    "auto_play_tts": true
  }
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
1. æŸ¥è¯¢ç”¨æˆ·çš„è®¾ç½®è®°å½•
2. å¦‚æœå­˜åœ¨å°±æ›´æ–°ï¼Œä¸å­˜åœ¨å°±åˆ›å»º
3. è®¾ç½®ä»¥JSONæ ¼å¼å­˜å‚¨ï¼ˆçµæ´»ï¼‰

##### ğŸ“Š åŒæ­¥çŠ¶æ€

**æŸ¥çœ‹åŒæ­¥æ¦‚è§ˆï¼š**
```
GET /api/v1/sync/status

è¿”å›æ•°æ®ï¼š
{
  "contacts": {
    "count": 5,
    "last_updated": "2025-01-14T10:00:00Z"
  },
  "messages": {
    "count": 120,
    "last_updated": "2025-01-14T11:00:00Z"
  },
  "settings": {
    "last_updated": "2025-01-14T09:00:00Z"
  }
}
```

**å¹²äº†ä»€ä¹ˆï¼š**
ç»Ÿè®¡ç”¨æˆ·çš„æ•°æ®é‡å’Œæœ€åæ›´æ–°æ—¶é—´

---

### 4ï¸âƒ£ admin_api.py - ç®¡ç†åå°

**ä½œç”¨ï¼š** ç®¡ç†å‘˜ç®¡ç†ç”¨æˆ·å’Œé‚€è¯·ç 

#### åŠŸèƒ½åˆ—è¡¨ï¼š

##### ğŸŸï¸ é‚€è¯·ç ç®¡ç†

**åˆ›å»ºé‚€è¯·ç ï¼š**
```
POST /api/v1/admin/invites

è¯·æ±‚æ•°æ®ï¼š
{
  "code": "WELCOME2025",  // å¯é€‰ï¼Œä¸å¡«è‡ªåŠ¨ç”Ÿæˆ
  "max_uses": 10          // å¯ä½¿ç”¨10æ¬¡
}

è¿”å›æ•°æ®ï¼š
{
  "code": "WELCOME2025",
  "max_uses": 10,
  "used_count": 0,
  "enabled": true
}
```

**æŸ¥çœ‹é‚€è¯·ç åˆ—è¡¨ï¼š**
```
GET /api/v1/admin/invites

è¿”å›æ•°æ®ï¼š
[
  {
    "code": "WELCOME2025",
    "max_uses": 10,
    "used_count": 3,      // å·²ä½¿ç”¨3æ¬¡
    "enabled": true
  }
]
```

**æ›´æ–°é‚€è¯·ç ï¼š**
```
PATCH /api/v1/admin/invites/WELCOME2025

è¯·æ±‚æ•°æ®ï¼š
{
  "max_uses": 20,         // æ”¹ä¸º20æ¬¡
  "enabled": false        // ç¦ç”¨
}
```

##### ğŸ‘¥ ç”¨æˆ·ç®¡ç†

**æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ï¼š**
```
GET /api/v1/admin/users

è¿”å›æ•°æ®ï¼š
[
  {
    "id": 1,
    "username": "å¼ ä¸‰",
    "email": "zhangsan@example.com",
    "is_admin": false,
    "is_active": true,
    "contacts_count": 5,    // æœ‰5ä¸ªè”ç³»äºº
    "messages_count": 120   // æœ‰120æ¡æ¶ˆæ¯
  }
]
```

**æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…ï¼š**
```
GET /api/v1/admin/users/1

è¿”å›æ•°æ®ï¼š
{
  "user": { ... },
  "stats": {
    "contacts_count": 5,
    "messages_count": 120
  },
  "recent_contacts": [ ... ]  // æœ€è¿‘çš„5ä¸ªè”ç³»äºº
}
```

**ç¦ç”¨/å¯ç”¨ç”¨æˆ·ï¼š**
```
PATCH /api/v1/admin/users/1

è¯·æ±‚æ•°æ®ï¼š
{
  "is_active": false  // ç¦ç”¨ç”¨æˆ·
}
```

**åˆ é™¤ç”¨æˆ·ï¼š**
```
DELETE /api/v1/admin/users/1
```

**å¹²äº†ä»€ä¹ˆï¼š**
åˆ é™¤ç”¨æˆ·åŠå…¶æ‰€æœ‰æ•°æ®ï¼ˆè”ç³»äººã€æ¶ˆæ¯ã€è®¾ç½®ï¼‰

##### ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡

**æŸ¥çœ‹ç³»ç»Ÿæ¦‚è§ˆï¼š**
```
GET /api/v1/admin/stats

è¿”å›æ•°æ®ï¼š
{
  "users": {
    "total": 100,       // æ€»ç”¨æˆ·æ•°
    "active": 95,       // æ´»è·ƒç”¨æˆ·
    "admin": 2          // ç®¡ç†å‘˜æ•°
  },
  "data": {
    "contacts": 500,    // æ€»è”ç³»äººæ•°
    "messages": 12000   // æ€»æ¶ˆæ¯æ•°
  },
  "invites": {
    "total": 10,        // æ€»é‚€è¯·ç æ•°
    "active": 5         // å¯ç”¨é‚€è¯·ç æ•°
  }
}
```

---

### 5ï¸âƒ£ models.py - æ•°æ®æ¨¡å‹

**ä½œç”¨ï¼š** å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„

#### æ•°æ®åº“è¡¨ï¼š

##### ğŸ‘¤ users - ç”¨æˆ·è¡¨
```python
users
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ username (ç”¨æˆ·åï¼Œå”¯ä¸€)
â”œâ”€â”€ email (é‚®ç®±ï¼Œå”¯ä¸€)
â”œâ”€â”€ password_hash (åŠ å¯†åçš„å¯†ç )
â”œâ”€â”€ is_admin (æ˜¯å¦ç®¡ç†å‘˜)
â”œâ”€â”€ is_active (æ˜¯å¦å¯ç”¨)
â””â”€â”€ created_at (åˆ›å»ºæ—¶é—´)
```

##### ğŸŸï¸ invite_codes - é‚€è¯·ç è¡¨
```python
invite_codes
â”œâ”€â”€ code (é‚€è¯·ç ï¼Œä¸»é”®)
â”œâ”€â”€ max_uses (æœ€å¤§ä½¿ç”¨æ¬¡æ•°)
â”œâ”€â”€ used_count (å·²ä½¿ç”¨æ¬¡æ•°)
â”œâ”€â”€ enabled (æ˜¯å¦å¯ç”¨)
â””â”€â”€ created_at (åˆ›å»ºæ—¶é—´)
```

##### ğŸ“‡ contacts - è”ç³»äººè¡¨
```python
contacts
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ user_id (æ‰€å±ç”¨æˆ·)
â”œâ”€â”€ contact_id (UUIDï¼Œå”¯ä¸€)
â”œâ”€â”€ name (åå­—)
â”œâ”€â”€ avatar_url (å¤´åƒURL)
â”œâ”€â”€ character_data (è§’è‰²æ•°æ®ï¼ŒJSON)
â”œâ”€â”€ is_deleted (æ˜¯å¦åˆ é™¤)
â”œâ”€â”€ created_at (åˆ›å»ºæ—¶é—´)
â””â”€â”€ updated_at (æ›´æ–°æ—¶é—´)
```

##### ğŸ’¬ messages - æ¶ˆæ¯è¡¨
```python
messages
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ user_id (æ‰€å±ç”¨æˆ·)
â”œâ”€â”€ message_id (UUIDï¼Œå”¯ä¸€)
â”œâ”€â”€ contact_id (æ‰€å±è”ç³»äºº)
â”œâ”€â”€ role (è§’è‰²ï¼šuser/assistant)
â”œâ”€â”€ content (æ¶ˆæ¯å†…å®¹)
â”œâ”€â”€ metadata (å…ƒæ•°æ®ï¼ŒJSON)
â”œâ”€â”€ is_deleted (æ˜¯å¦åˆ é™¤)
â””â”€â”€ created_at (åˆ›å»ºæ—¶é—´)
```

##### âš™ï¸ user_settings - ç”¨æˆ·è®¾ç½®è¡¨
```python
user_settings
â”œâ”€â”€ user_id (ç”¨æˆ·IDï¼Œä¸»é”®)
â”œâ”€â”€ settings_json (è®¾ç½®æ•°æ®ï¼ŒJSON)
â””â”€â”€ updated_at (æ›´æ–°æ—¶é—´)
```

---

### 6ï¸âƒ£ database.py - æ•°æ®åº“è¿æ¥

**ä½œç”¨ï¼š** è¿æ¥SQLiteæ•°æ®åº“ï¼Œåˆ›å»ºè¡¨

**ä»£ç é€»è¾‘ï¼š**
```python
# 1. è¿æ¥æ•°æ®åº“
DATABASE_URL = "sqlite:///./data/sync.db"
engine = create_engine(DATABASE_URL)

# 2. åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(bind=engine)

# 3. åˆå§‹åŒ–æ•°æ®åº“è¡¨
def init_db():
    # å¯¼å…¥æ‰€æœ‰æ¨¡å‹
    from models import User, Contact, Message, ...
    
    # åˆ›å»ºæ‰€æœ‰è¡¨
    Base.metadata.create_all(bind=engine)

# 4. è·å–æ•°æ®åº“ä¼šè¯ï¼ˆç»™APIç”¨ï¼‰
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

**æ•°æ®å­˜å‚¨ä½ç½®ï¼š**
- æ•°æ®åº“æ–‡ä»¶ï¼š`cloud_backend/data/sync.db`
- SQLiteæ ¼å¼ï¼Œå¯ä»¥ç”¨å·¥å…·æŸ¥çœ‹

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šç”¨æˆ·æ³¨å†Œå¹¶åŒæ­¥æ•°æ®

**ç¬¬1æ­¥ï¼šç”¨æˆ·æ³¨å†Œ**
```
å®¢æˆ·ç«¯ â†’ POST /api/v1/auth/register
         {username: "å¼ ä¸‰", password: "123456"}

åç«¯å¤„ç†ï¼š
1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ âœ…
2. åŠ å¯†å¯†ç  âœ…
3. ä¿å­˜åˆ°usersè¡¨ âœ…
4. ç”ŸæˆToken âœ…

åç«¯ â†’ å®¢æˆ·ç«¯
       {access_token: "xxx", user: {...}}
```

**ç¬¬2æ­¥ï¼šå®¢æˆ·ç«¯ä¿å­˜Token**
```
å®¢æˆ·ç«¯ï¼šæŠŠTokenä¿å­˜åˆ°å®‰å…¨å­˜å‚¨
       ï¼ˆflutter_secure_storageï¼‰
```

**ç¬¬3æ­¥ï¼šåˆ›å»ºè”ç³»äººï¼ˆæœ¬åœ°ï¼‰**
```
å®¢æˆ·ç«¯ï¼šç”¨æˆ·åˆ›å»ºè§’è‰²"å°ç¾"
       ä¿å­˜åˆ°æœ¬åœ°SQLite
       æ ‡è®°ä¸º"æœªåŒæ­¥"(is_synced=false)
```

**ç¬¬4æ­¥ï¼šè‡ªåŠ¨åŒæ­¥**
```
5åˆ†é’Ÿå...

å®¢æˆ·ç«¯ â†’ POST /api/v1/sync/contacts
         Headers: Authorization: Bearer xxx
         {items: [{contact_id: "uuid-123", name: "å°ç¾", ...}]}

åç«¯å¤„ç†ï¼š
1. éªŒè¯Token âœ…
2. è·å–ç”¨æˆ·ID âœ…
3. ä¿å­˜åˆ°contactsè¡¨ âœ…

åç«¯ â†’ å®¢æˆ·ç«¯
       {synced: 1, conflicts: []}

å®¢æˆ·ç«¯ï¼šæ ‡è®°ä¸º"å·²åŒæ­¥"(is_synced=true)
```

**ç¬¬5æ­¥ï¼šå…¶ä»–è®¾å¤‡ç™»å½•**
```
è®¾å¤‡2 â†’ POST /api/v1/auth/login
        {username: "å¼ ä¸‰", password: "123456"}

åç«¯ â†’ è®¾å¤‡2
       {access_token: "yyy", user: {...}}

è®¾å¤‡2 â†’ GET /api/v1/sync/contacts
        Headers: Authorization: Bearer yyy

åç«¯ â†’ è®¾å¤‡2
       {contacts: [{contact_id: "uuid-123", name: "å°ç¾", ...}]}

è®¾å¤‡2ï¼šä¿å­˜åˆ°æœ¬åœ°SQLite âœ…
       ç°åœ¨èƒ½çœ‹åˆ°"å°ç¾"äº†ï¼
```

---

### åœºæ™¯2ï¼šå†²çªå¤„ç†

**æƒ…å†µï¼š** ç”¨æˆ·åœ¨ä¸¤ä¸ªè®¾å¤‡ä¸ŠåŒæ—¶ä¿®æ”¹äº†åŒä¸€ä¸ªè”ç³»äºº

**è®¾å¤‡1ï¼š**
```
ä¿®æ”¹"å°ç¾"çš„åå­—ä¸º"å°ç¾ç¾"
updated_at: 2025-01-14 10:00:00
```

**è®¾å¤‡2ï¼š**
```
ä¿®æ”¹"å°ç¾"çš„å¤´åƒ
updated_at: 2025-01-14 10:01:00  ï¼ˆæ™š1åˆ†é’Ÿï¼‰
```

**åŒæ­¥æ—¶ï¼š**
```
è®¾å¤‡1 â†’ POST /api/v1/sync/contacts
        {name: "å°ç¾ç¾", updated_at: "10:00:00"}

åç«¯ï¼šä¿å­˜æˆåŠŸ âœ…

è®¾å¤‡2 â†’ POST /api/v1/sync/contacts
        {avatar: "new.jpg", updated_at: "10:01:00"}

åç«¯ï¼šæ£€æµ‹åˆ°å†²çªï¼
      æœåŠ¡å™¨ç‰ˆæœ¬(10:00:00) < å®¢æˆ·ç«¯ç‰ˆæœ¬(10:01:00)
      
åç«¯ â†’ è®¾å¤‡2
       {conflicts: [{
         reason: "æœåŠ¡å™¨ç‰ˆæœ¬æ›´æ–°",
         server_version: {name: "å°ç¾ç¾", ...},
         client_version: {avatar: "new.jpg", ...}
       }]}
```

**å½“å‰ç­–ç•¥ï¼š** æœåŠ¡å™¨ç‰ˆæœ¬ä¼˜å…ˆï¼ˆServer-Winsï¼‰

---

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. å¯†ç åŠ å¯†
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"])

# æ³¨å†Œæ—¶ï¼š
hashed = pwd_context.hash("123456")
# å­˜å‚¨ï¼š$2b$12$xxx...ï¼ˆä¸æ˜¯æ˜æ–‡ï¼‰

# ç™»å½•æ—¶ï¼š
pwd_context.verify("123456", hashed)  # True
```

### 2. JWT Token
```python
from jose import jwt

# ç”ŸæˆToken
payload = {"sub": user_id, "exp": è¿‡æœŸæ—¶é—´}
token = jwt.encode(payload, SECRET_KEY, "HS256")

# éªŒè¯Token
payload = jwt.decode(token, SECRET_KEY, "HS256")
user_id = payload["sub"]
```

**Tokenå†…å®¹ç¤ºä¾‹ï¼š**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
eyJzdWIiOjEsImV4cCI6MTcwNTIwMDAwMH0.
xxx...

è§£ç åï¼š
{
  "sub": 1,              // ç”¨æˆ·ID
  "exp": 1705200000      // è¿‡æœŸæ—¶é—´
}
```

### 3. APIè®¤è¯
```python
# æ¯ä¸ªéœ€è¦è®¤è¯çš„APIéƒ½ä¼šï¼š
1. ä»è¯·æ±‚å¤´è¯»å–Token
2. è§£ç Tokenè·å–user_id
3. éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
4. æ‰§è¡Œæ“ä½œ
```

---

## ğŸ“Š æ€§èƒ½ç‰¹ç‚¹

### èµ„æºå ç”¨ï¼š
- **å¯åŠ¨å†…å­˜**ï¼š~50MB
- **æ•°æ®åº“å¤§å°**ï¼š1000ç”¨æˆ·çº¦50MB
- **APIå“åº”**ï¼šå¹³å‡50-100ms

### å¹¶å‘èƒ½åŠ›ï¼š
- **å•æ ¸1G**ï¼šæ”¯æŒ1000æ´»è·ƒç”¨æˆ·
- **2æ ¸2G**ï¼šæ”¯æŒ5000æ´»è·ƒç”¨æˆ·

### ä¼˜åŒ–ç‚¹ï¼š
- âœ… ä½¿ç”¨ç´¢å¼•ï¼ˆcontact_id, message_idç­‰ï¼‰
- âœ… æ‰¹é‡æ“ä½œï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
- âœ… å¢é‡åŒæ­¥ï¼ˆåªä¼ è¾“å˜åŒ–çš„æ•°æ®ï¼‰

---

## ğŸ› ï¸ å¦‚ä½•ä¿®æ”¹åŠŸèƒ½

### ç¤ºä¾‹ï¼šæ·»åŠ "æ”¶è—æ¶ˆæ¯"åŠŸèƒ½

**ç¬¬1æ­¥ï¼šä¿®æ”¹æ•°æ®æ¨¡å‹ï¼ˆmodels.pyï¼‰**
```python
class Message(Base):
    # ... ç°æœ‰å­—æ®µ ...
    is_favorited = Column(Boolean, default=False)  # æ–°å¢
```

**ç¬¬2æ­¥ï¼šæ·»åŠ APIï¼ˆsync_api.pyï¼‰**
```python
@router.patch("/messages/{message_id}/favorite")
async def favorite_message(
    message_id: str,
    is_favorited: bool,
    user_id: int = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    message = db.query(Message).filter(
        Message.message_id == message_id,
        Message.user_id == user_id
    ).first()
    
    if not message:
        raise HTTPException(404, "æ¶ˆæ¯ä¸å­˜åœ¨")
    
    message.is_favorited = is_favorited
    db.commit()
    
    return {"status": "ok"}
```

**ç¬¬3æ­¥ï¼šé‡å¯æœåŠ¡**
```bash
# æ•°æ®åº“ä¼šè‡ªåŠ¨æ·»åŠ æ–°å­—æ®µ
python main.py
```

**ç¬¬4æ­¥ï¼šåœ¨Flutterä¸­è°ƒç”¨**
```dart
await apiClient.dio.patch(
  '/api/v1/sync/messages/$messageId/favorite',
  data: {'is_favorited': true},
);
```

---

## â“ å¸¸è§ç–‘é—®è§£ç­”

### Q1: ä¸ºä»€ä¹ˆä¸æŠŠAIé€»è¾‘æ”¾åç«¯ï¼Ÿ
**A:** 
- åç«¯è¦å¤„ç†æ‰€æœ‰ç”¨æˆ·çš„è¯·æ±‚ï¼Œå‹åŠ›å¤§
- ç”¨æˆ·API Keyåœ¨å®¢æˆ·ç«¯ï¼Œæ›´å®‰å…¨
- å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨AIï¼Œé€Ÿåº¦å¿«

### Q2: æ•°æ®å­˜åœ¨å“ªé‡Œï¼Ÿ
**A:**
- åç«¯ï¼š`cloud_backend/data/sync.db`ï¼ˆSQLiteæ–‡ä»¶ï¼‰
- å¯ä»¥å¤‡ä»½è¿™ä¸ªæ–‡ä»¶

### Q3: å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“å†…å®¹ï¼Ÿ
**A:**
ä½¿ç”¨SQLiteæµè§ˆå™¨ï¼š
- DB Browser for SQLite
- æˆ–åœ¨çº¿å·¥å…·ï¼šhttps://sqliteonline.com/

### Q4: Tokenè¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ
**A:**
Tokenæœ‰æ•ˆæœŸ7å¤©ï¼Œè¿‡æœŸåï¼š
1. å®¢æˆ·ç«¯æ£€æµ‹åˆ°401é”™è¯¯
2. è‡ªåŠ¨æ¸…é™¤Token
3. æç¤ºç”¨æˆ·é‡æ–°ç™»å½•

### Q5: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ
**A:**
```bash
# å¤‡ä»½æ•°æ®åº“æ–‡ä»¶
cp data/sync.db data/sync_backup_20250114.db

# æˆ–ç”¨Docker
docker exec mygril-sync cp /app/data/sync.db /app/data/backup.db
```

### Q6: èƒ½æ¢æˆMySQL/PostgreSQLå—ï¼Ÿ
**A:** å¯ä»¥ï¼ä¿®æ”¹`.env`ï¼š
```env
DATABASE_URL=postgresql://user:pass@localhost/mygril
```

### Q7: å¦‚ä½•æŸ¥çœ‹æ—¥å¿—ï¼Ÿ
**A:**
```bash
# Dockeræ–¹å¼
docker-compose logs -f

# ç›´æ¥è¿è¡Œ
# æ—¥å¿—ä¼šè¾“å‡ºåˆ°ç»ˆç«¯
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

**æŸ¥çœ‹APIæ–‡æ¡£ï¼š**
```
å¯åŠ¨åç«¯åè®¿é—®ï¼šhttp://localhost:8000/docs
```

**æµ‹è¯•APIï¼š**
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æ³¨å†Œ
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'

# ç™»å½•
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'
```

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹ï¼š**
1. åç«¯åªç®¡å­˜å‚¨å’Œè®¤è¯ï¼Œä¸ç®¡AI
2. ä½¿ç”¨JWT TokenéªŒè¯èº«ä»½
3. å¢é‡åŒæ­¥ï¼ŒèŠ‚çœæµé‡
4. å†²çªæ—¶æœåŠ¡å™¨ç‰ˆæœ¬ä¼˜å…ˆ
5. æ‰€æœ‰å¯†ç éƒ½åŠ å¯†å­˜å‚¨

**ä½ éœ€è¦çŸ¥é“çš„ï¼š**
- âœ… å¦‚ä½•å¯åŠ¨åç«¯
- âœ… å¦‚ä½•åˆ›å»ºç®¡ç†å‘˜
- âœ… APIåœ°å€åœ¨å“ªé‡Œ
- âœ… æ•°æ®å­˜åœ¨å“ªé‡Œ
- âœ… å¦‚ä½•å¤‡ä»½

**ä½ ä¸éœ€è¦æ‡‚çš„ï¼š**
- âŒ å…·ä½“çš„åŠ å¯†ç®—æ³•
- âŒ æ•°æ®åº“çš„SQLè¯­å¥
- âŒ FastAPIçš„å†…éƒ¨å®ç°

è¿™ä¸ªåç«¯å·²ç»å¸®ä½ å¤„ç†å¥½äº†æ‰€æœ‰å¤æ‚çš„ç»†èŠ‚ï¼ğŸ‰

---

## ğŸ–ï¸ ä¼šå‘˜åˆ†çº§ç³»ç»Ÿå’Œäº‘æœåŠ¡

### æ¦‚è¿°

ç°åœ¨åç«¯æ”¯æŒ**ä¼šå‘˜åˆ†çº§ç³»ç»Ÿ**ï¼Œä¸åŒç­‰çº§çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸åŒçš„äº‘æœåŠ¡åŠŸèƒ½ã€‚

#### ä¼šå‘˜ç­‰çº§ï¼š
- **Level 0ï¼ˆå…è´¹ï¼‰**ï¼šåŸºç¡€åŒæ­¥åŠŸèƒ½
- **Level 1ï¼ˆåŸºç¡€ï¼‰**ï¼š+ æ•°æ®å¤‡ä»½
- **Level 2ï¼ˆæ ‡å‡†ï¼‰**ï¼š+ Keyåˆ†å‘å’Œé¢åº¦ç®¡ç†
- **Level 3ï¼ˆé«˜çº§ï¼‰**ï¼š+ äº‘è§¦å‘å™¨
- **Level 4ï¼ˆä¸“ä¸šï¼‰**ï¼š+ äº‘è®°å¿†åº“
- **Level 99ï¼ˆç®¡ç†å‘˜ï¼‰**ï¼šæ‰€æœ‰åŠŸèƒ½ + ç®¡ç†åå°

### 7ï¸âƒ£ Keyåˆ†å‘ç³»ç»Ÿï¼ˆLevel 2+ï¼‰

**ä½œç”¨ï¼š** ç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†API Keyï¼Œç”¨æˆ·ç”³è¯·ä½¿ç”¨ï¼Œè‡ªåŠ¨æ‰£é™¤é¢åº¦

#### æ ¸å¿ƒæ¦‚å¿µï¼š
```
ç®¡ç†å‘˜ â†’ æ·»åŠ OpenAI Keyåˆ°æ± å­ï¼ˆæ€»é¢åº¦10ä¸‡tokensï¼‰
       â†’ åˆ†é…ç»™ç”¨æˆ·Aï¼ˆæœˆé¢åº¦5000 tokensï¼‰

ç”¨æˆ·A â†’ è¯·æ±‚ä½¿ç”¨OpenAI Key
      â†’ æ¶ˆè€—100 tokens
      â†’ å‰©ä½™é¢åº¦4900 tokens
```

#### APIç«¯ç‚¹ï¼š

**ç”¨æˆ·ç«¯ï¼š**

```
# è·å–å¯ç”¨çš„Provideråˆ—è¡¨
GET /api/v1/keys/providers
è¿”å›: ["openai", "gemini", "claude"]

# ç”³è¯·ä½¿ç”¨Key
POST /api/v1/keys/request
{
  "provider": "openai",
  "estimated_tokens": 100
}
è¿”å›: {
  "api_key": "sk-xxx...",  // è§£å¯†åçš„Key
  "quota_remaining": 4900
}

# æŸ¥çœ‹æˆ‘çš„é¢åº¦
GET /api/v1/keys/quota
è¿”å›: {
  "openai": {
    "quota_total": 5000,
    "quota_used": 100,
    "quota_remaining": 4900,
    "reset_at": "2025-02-01T00:00:00Z"
  }
}
```

**ç®¡ç†å‘˜ç«¯ï¼š**

```
# æ·»åŠ Keyåˆ°æ± å­
POST /api/v1/keys/admin/pool
{
  "provider": "openai",
  "api_key": "sk-xxx...",
  "quota_total": 100000
}

# åˆ†é…é¢åº¦ç»™ç”¨æˆ·
POST /api/v1/keys/admin/assign
{
  "unique_id": "USER-00001",
  "provider": "openai",
  "quota_total": 5000,
  "monthly_reset": true  // æ¯æœˆè‡ªåŠ¨é‡ç½®
}

# æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡
GET /api/v1/keys/admin/overview
```

### 8ï¸âƒ£ æ•°æ®å¤‡ä»½ç³»ç»Ÿï¼ˆLevel 1+ï¼‰

**ä½œç”¨ï¼š** äº‘ç«¯å¤‡ä»½å®Œæ•´æ•°æ®ï¼Œæ”¯æŒä¸€é”®æ¢å¤

#### APIç«¯ç‚¹ï¼š

```
# åˆ›å»ºå¤‡ä»½
POST /api/v1/backup/create
{
  "backup_name": "2025å¹´1æœˆå¤‡ä»½",
  "description": "æ›´æ¢æ‰‹æœºå‰çš„å¤‡ä»½",
  "backup_data": "{...}"  // JSONæ ¼å¼çš„å®Œæ•´æ•°æ®
}

# è·å–å¤‡ä»½åˆ—è¡¨
GET /api/v1/backup/list
è¿”å›: [
  {
    "id": 1,
    "backup_name": "2025å¹´1æœˆå¤‡ä»½",
    "file_size": 1024000,  // å­—èŠ‚
    "created_at": "2025-01-14T10:00:00Z"
  }
]

# æ¢å¤å¤‡ä»½
POST /api/v1/backup/1/restore
è¿”å›: {
  "backup_data": "{...}"  // å®Œæ•´æ•°æ®
}

# åˆ é™¤å¤‡ä»½
DELETE /api/v1/backup/1

# å¤‡ä»½ç»Ÿè®¡
GET /api/v1/backup/stats/my
è¿”å›: {
  "total_backups": 5,
  "total_size": 5120000
}
```

### 9ï¸âƒ£ äº‘è§¦å‘å™¨ï¼ˆLevel 3+ï¼‰

**ä½œç”¨ï¼š** è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œæ”¯æŒå®šæ—¶è§¦å‘ã€äº‹ä»¶è§¦å‘ã€æ¡ä»¶è§¦å‘

#### è§¦å‘å™¨ç±»å‹ï¼š

1. **å®šæ—¶è§¦å‘ï¼ˆscheduleï¼‰**
```json
{
  "trigger_type": "schedule",
  "trigger_config": {
    "cron": "0 9 * * *",  // æ¯å¤©9ç‚¹
    "timezone": "Asia/Shanghai"
  },
  "action_config": {
    "action_type": "backup"  // è‡ªåŠ¨å¤‡ä»½
  }
}
```

2. **äº‹ä»¶è§¦å‘ï¼ˆeventï¼‰**
```json
{
  "trigger_type": "event",
  "trigger_config": {
    "event_type": "new_message"  // æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶
  },
  "action_config": {
    "action_type": "notification"
  }
}
```

3. **æ¡ä»¶è§¦å‘ï¼ˆconditionï¼‰**
```json
{
  "trigger_type": "condition",
  "trigger_config": {
    "condition_type": "quota_low",
    "threshold": 100  // é¢åº¦ä½äº100æ—¶
  },
  "action_config": {
    "action_type": "notification",
    "params": {
      "message": "é¢åº¦å³å°†ç”¨å®Œ"
    }
  }
}
```

#### APIç«¯ç‚¹ï¼š

```
# åˆ›å»ºè§¦å‘å™¨
POST /api/v1/triggers/create
{
  "trigger_name": "æ¯æ—¥è‡ªåŠ¨å¤‡ä»½",
  "trigger_type": "schedule",
  "trigger_config": {...},
  "action_config": {...}
}

# è·å–è§¦å‘å™¨åˆ—è¡¨
GET /api/v1/triggers/list

# å¯ç”¨/ç¦ç”¨è§¦å‘å™¨
POST /api/v1/triggers/1/toggle

# æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
GET /api/v1/triggers/1/logs

# è§¦å‘å™¨ç»Ÿè®¡
GET /api/v1/triggers/stats/my
```

### ğŸ”Ÿ äº‘è®°å¿†åº“ï¼ˆLevel 4+ï¼‰

**ä½œç”¨ï¼š** é•¿æœŸè®°å¿†å­˜å‚¨ï¼Œæ”¯æŒè¯­ä¹‰æœç´¢

#### è®°å¿†ç±»å‹ï¼š
- **conversation**ï¼šå¯¹è¯è®°å¿†
- **fact**ï¼šäº‹å®è®°å¿†
- **preference**ï¼šåå¥½è®°å¿†
- **custom**ï¼šè‡ªå®šä¹‰

#### APIç«¯ç‚¹ï¼š

**å­˜å‚¨è®°å¿†ï¼š**
```
POST /api/v1/memory/create
{
  "memory_type": "preference",
  "memory_key": "favorite_food",
  "memory_content": "ç”¨æˆ·å–œæ¬¢åƒå››å·ç«é”…",
  "contact_id": "uuid-123",  // å…³è”è”ç³»äºº
  "importance_score": 8,     // é‡è¦æ€§1-10
  "embedding_vector": [0.1, 0.2, ...]  // å¯é€‰çš„å‘é‡åµŒå…¥
}
```

**å…³é”®è¯æœç´¢ï¼š**
```
POST /api/v1/memory/search
{
  "query": "ç«é”…",
  "search_type": "keyword",
  "contact_id": "uuid-123",
  "min_importance": 5,
  "limit": 10
}
è¿”å›: {
  "memories": [...],
  "total_results": 5,
  "search_time_ms": 15
}
```

**è¯­ä¹‰æœç´¢ï¼š**
```
POST /api/v1/memory/search
{
  "query": "ç”¨æˆ·çš„é¥®é£Ÿåå¥½",
  "search_type": "semantic",
  "query_embedding": [0.1, 0.2, ...],  // æŸ¥è¯¢å‘é‡
  "limit": 10
}
```

**è®°å¿†ç®¡ç†ï¼š**
```
# è·å–è®°å¿†åˆ—è¡¨
GET /api/v1/memory/list?memory_type=preference

# è·å–è®°å¿†è¯¦æƒ…ï¼ˆè‡ªåŠ¨å¢åŠ è®¿é—®æ¬¡æ•°ï¼‰
GET /api/v1/memory/1

# æ›´æ–°è®°å¿†
PUT /api/v1/memory/1
{
  "memory_content": "æ›´æ–°çš„å†…å®¹",
  "importance_score": 9
}

# åˆ é™¤è®°å¿†
DELETE /api/v1/memory/1

# è®°å¿†ç»Ÿè®¡
GET /api/v1/memory/stats/my
è¿”å›: {
  "total_memories": 100,
  "by_type": {
    "conversation": 50,
    "fact": 30,
    "preference": 20
  },
  "most_accessed": [...]  // æœ€å¸¸è®¿é—®çš„è®°å¿†
}
```

### ğŸ›¡ï¸ ç®¡ç†å‘˜åŠŸèƒ½æ‰©å±•

**è®¾ç½®ç”¨æˆ·ç­‰çº§ï¼š**
```
POST /api/v1/admin/users/USER-00001/level
{
  "user_level": 2,  // æ ‡å‡†ä¼šå‘˜
  "expires_at": "2026-01-14T00:00:00Z"  // åˆ°æœŸæ—¶é—´
}
```

**ç³»ç»Ÿç»Ÿè®¡ï¼ˆåŒ…å«äº‘æœåŠ¡ï¼‰ï¼š**
```
GET /api/v1/admin/stats
è¿”å›: {
  "users": {
    "total": 100,
    "by_level": {
      "level_0_å…è´¹": 50,
      "level_1_åŸºç¡€": 20,
      "level_2_æ ‡å‡†": 15,
      "level_3_é«˜çº§": 10,
      "level_4_ä¸“ä¸š": 4,
      "level_99_ç®¡ç†å‘˜": 1
    }
  },
  "cloud_services": {
    "api_keys": {
      "total": 5,
      "active": 3
    },
    "backups": {
      "total": 500,
      "users": 80
    },
    "triggers": {
      "total": 120,
      "active": 100
    },
    "memories": {
      "total": 10000,
      "users": 50
    }
  }
}
```

---

## ğŸ“‹ æ•°æ®æ¨¡å‹æ‰©å±•

### æ–°å¢è¡¨ï¼š

**api_key_pool** - API Keyæ± 
```python
â”œâ”€â”€ id
â”œâ”€â”€ provider (openai/gemini/claude)
â”œâ”€â”€ api_key_encrypted (åŠ å¯†çš„Key)
â”œâ”€â”€ quota_total (æ€»é¢åº¦)
â”œâ”€â”€ quota_used (å·²ä½¿ç”¨)
â”œâ”€â”€ is_active
â””â”€â”€ created_at
```

**user_quota** - ç”¨æˆ·é¢åº¦
```python
â”œâ”€â”€ id
â”œâ”€â”€ user_id
â”œâ”€â”€ provider
â”œâ”€â”€ quota_total
â”œâ”€â”€ quota_used
â”œâ”€â”€ quota_reset_at (é‡ç½®æ—¶é—´)
â””â”€â”€ created_at
```

**data_backups** - æ•°æ®å¤‡ä»½
```python
â”œâ”€â”€ id
â”œâ”€â”€ user_id
â”œâ”€â”€ backup_name
â”œâ”€â”€ backup_data (JSON)
â”œâ”€â”€ file_size
â””â”€â”€ created_at
```

**cloud_triggers** - äº‘è§¦å‘å™¨
```python
â”œâ”€â”€ id
â”œâ”€â”€ user_id
â”œâ”€â”€ trigger_name
â”œâ”€â”€ trigger_type
â”œâ”€â”€ trigger_config (JSON)
â”œâ”€â”€ action_config (JSON)
â”œâ”€â”€ is_active
â”œâ”€â”€ last_triggered_at
â””â”€â”€ created_at
```

**memory_store** - è®°å¿†å­˜å‚¨
```python
â”œâ”€â”€ id
â”œâ”€â”€ user_id
â”œâ”€â”€ contact_id
â”œâ”€â”€ memory_type
â”œâ”€â”€ memory_key
â”œâ”€â”€ memory_content
â”œâ”€â”€ embedding_vector (JSON)
â”œâ”€â”€ importance_score
â”œâ”€â”€ access_count
â””â”€â”€ created_at
```

---

## ğŸš€ ä½¿ç”¨æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·å‡çº§åˆ°Level 2ï¼Œä½¿ç”¨Keyåˆ†å‘

**ç¬¬1æ­¥ï¼šç®¡ç†å‘˜è®¾ç½®ç”¨æˆ·ç­‰çº§**
```bash
curl -X POST http://localhost:8000/api/v1/admin/users/USER-00001/level \
  -H "Authorization: Bearer admin_token" \
  -d '{"user_level": 2, "expires_at": "2026-01-01T00:00:00Z"}'
```

**ç¬¬2æ­¥ï¼šç®¡ç†å‘˜æ·»åŠ Keyåˆ°æ± å­**
```bash
curl -X POST http://localhost:8000/api/v1/keys/admin/pool \
  -H "Authorization: Bearer admin_token" \
  -d '{"provider": "openai", "api_key": "sk-xxx", "quota_total": 100000}'
```

**ç¬¬3æ­¥ï¼šç®¡ç†å‘˜åˆ†é…é¢åº¦ç»™ç”¨æˆ·**
```bash
curl -X POST http://localhost:8000/api/v1/keys/admin/assign \
  -H "Authorization: Bearer admin_token" \
  -d '{"unique_id": "USER-00001", "provider": "openai", "quota_total": 5000}'
```

**ç¬¬4æ­¥ï¼šç”¨æˆ·ç”³è¯·ä½¿ç”¨Key**
```bash
curl -X POST http://localhost:8000/api/v1/keys/request \
  -H "Authorization: Bearer user_token" \
  -d '{"provider": "openai", "estimated_tokens": 100}'
```

**ç¬¬5æ­¥ï¼šç”¨æˆ·è°ƒç”¨OpenAI**
```dart
// Flutterå®¢æˆ·ç«¯
final response = await openai.chat.complete(
  apiKey: keyFromServer,  // ä»æœåŠ¡å™¨è·å–çš„Key
  messages: [...],
);
```

---

## ğŸ¯ æ€»ç»“

**æ–°å¢æ ¸å¿ƒåŠŸèƒ½ï¼š**
1. âœ… **ä¼šå‘˜åˆ†çº§**ï¼š5ä¸ªç­‰çº§ï¼ŒæŒ‰éœ€åˆ†é…æƒé™
2. âœ… **Keyåˆ†å‘**ï¼šç»Ÿä¸€ç®¡ç†API Keyï¼Œé˜²æ­¢æ»¥ç”¨
3. âœ… **æ•°æ®å¤‡ä»½**ï¼šäº‘ç«¯å¤‡ä»½ï¼Œå®‰å…¨å¯é 
4. âœ… **äº‘è§¦å‘å™¨**ï¼šè‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œå®šæ—¶æ‰§è¡Œ
5. âœ… **äº‘è®°å¿†åº“**ï¼šé•¿æœŸè®°å¿†ï¼Œè¯­ä¹‰æœç´¢

**é€‚ç”¨åœºæ™¯ï¼š**
- ä¸ªäººç”¨æˆ·ï¼šå…è´¹è´¦å·è¶³å¤Ÿæ—¥å¸¸ä½¿ç”¨
- é«˜çº§ç”¨æˆ·ï¼šä»˜è´¹äº«å—äº‘æœåŠ¡å’ŒKeyç®¡ç†
- å›¢é˜Ÿä½¿ç”¨ï¼šç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†èµ„æºå’Œæƒé™

å®Œæ•´æŠ€æœ¯æ–‡æ¡£è¯·å‚è€ƒï¼š`ä¼šå‘˜åˆ†çº§å’Œäº‘æœåŠ¡è®¾è®¡.md`
