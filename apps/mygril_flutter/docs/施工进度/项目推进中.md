# 施工进度（项目推进中）

## 2025-12-26

- 完成：聊天记录本地存储从 SharedPreferences 切换为 SQLite（Drift），聊天模块不再使用 `mygril.conversations`/`migrated_to_sqlite`。
- 完成：将原 `providers2.dart` 拆分为 `conversation_providers.dart`（会话状态/加载）与 `chat_actions.dart`（发送消息/插件/TTS等），`providers2.dart` 作为 export 入口，降低文件体积便于维护。
- 修复：`build_runner` 期间 `sidebar.dart` 出现编码损坏导致 drift_dev 报错（`Missing extension byte`），已将文件恢复为 UTF-8 并重新生成成功。
- 配置：Trae CN 排除索引/监听生成目录（建议排除 `**/.dart_tool/**`、`**/build/**`、`*.g.dart` 等），解决 Node 进程高占用导致的卡顿。
- 完成：记忆系统本地存储迁移到项目统一 Drift 数据库（新增 `memories` / `memory_tombstones`），记忆不再使用独立 sqflite 库。
- 完成：记忆召回链路（候选 300 → 余弦排序 → topK=3）与命中维护（`use_count`/`last_active_at`），并按 `n天前的对话摘要"..."` 输出给对话 AI。
- 完成：本地记忆回收站与自动淘汰（`deleted_at`/`purge_at` 7 天过期清理；>800 时优先淘汰非核心记忆 P<1），并写入墓碑列表用于后续云同步幂等。
- 文档：新增 `docs/记忆存储与召回方案/`（方案 + 重要性计算）与 `docs/备份与同步方案/同步范围清单.md`（scope 总账，含 `memory`/`memory.trash`）。

### 对未来开发/排查有用的备注

- 如果再次出现 drift_dev/分析器类似 `Missing extension byte`，优先检查最近改动的 `.dart` 文件是否含乱码/非 UTF-8 字节（常见于复制粘贴）。
- `providers2.dart` 现在是出口文件：排查“会话数据读写/列表状态”去 `conversation_providers.dart`；排查“发送消息/插件/TTS/占位消息”去 `chat_actions.dart`。
- 若计划继续做“生成 ID 公用化”，建议新增 `lib/src/core/utils/id_gen.dart` 提供 `genId()`，避免跨文件使用私有 `_genId` 引发编译错误。
- 记忆模块排查入口：召回/淘汰/回收站逻辑看 `lib/src/core/database/repositories/memory_repository.dart`；提示词注入看 `lib/src/features/plugins/memory/memory_plugin.dart`。
