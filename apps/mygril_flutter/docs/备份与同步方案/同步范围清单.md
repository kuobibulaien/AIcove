# 同步范围清单（Sync Scopes 总账）

面向：MyGril 项目的“云同步开关”设计与对接  
目的：把所有“可同步项”的 **内部代号（scope 字符串）** 统一登记，避免客户端/云端各写各的导致对不上。  

通俗类比：  
- scope 就像“快递包裹上的标签”。你在设置里勾选的是中文，但程序真正识别的是这个标签字符串。  
- 客户端、云端必须用同一套标签，否则就会出现“你勾了开关，但云端/客户端听不懂”的问题。  

---

## 1. Scope 字符串命名规范（统一口径）

- 使用小写 + 点号分层：`a.b`、`a.b.c`
- 语义清晰、可扩展：优先“功能域.子域”
- 回收站/冗余数据统一后缀：`.trash`
- 仅作为“开关键”，不要把实现细节塞进命名

示例：
- `chat.history`（聊天记录）
- `providers.keys`（渠道商 key）
- `memory`（记忆）
- `memory.trash`（记忆回收站/冗余记忆）

---

## 2. 这份清单怎么用（谁来维护）

- 这份文件是 **单一真相来源（Source of Truth）**：新增任何可同步项，必须先在这里登记。
- 客户端与云端的实现、接口字段、UI 勾选项，都以这里的 scope 字符串为准。
- `sync_scopes`（“全局勾选清单”）下发/存储时，本质就是这些 scope 的白名单集合（见 `施工手册_备份与云同步.md` 的定义）。

### 2.1 施工提示（结合当前项目）

- 本地 scope 的落点已经存在：`apps/mygril_flutter/lib/src/core/database/database.dart` 里有 `sync_scopes` 表（`enabled_scopes` 是 JSON 字符串）。
- 同步执行入口已经存在：`apps/mygril_flutter/lib/src/core/sync/sync_service.dart`，当前主要同步 conversations/messages/providers；后续扩展 memory/settings 等建议沿用同一套 pull/push + cursor + pending_operations 的结构。
- 因为 scope 会同时影响“客户端 UI 勾选”“云端接口行为”“本地落库/回收站策略”，所以这份清单必须优先更新，再做代码对接。

---

## 3. 当前已确定/正在使用的 scopes

| scope | UI 名称（建议） | 默认 | 内容说明 | 备注 |
|---|---|---:|---|---|
| `chat.history` | 聊天记录 | 开 | conversations/messages/message_blocks | 涉及回收站/分支/重生成覆盖等规则 |
| `characters.cards` | 角色卡/联系人 | 开 | 头像、人设 prompt、称呼、自称、立绘、voice 等 | 以云端优先为准（Cloud wins） |
| `providers.keys` | 渠道商配置（含 key） | 开 | providers 配置与 key | 需要服务端信封加密（见手册第 7 章） |

来源（已有文档约定）：
- `apps/mygril_flutter/docs/备份与同步方案/施工手册_备份与云同步.md`
- `apps/mygril_flutter/docs/备份与同步方案/云同步_范围回收站与分支策略.md`

---

## 4. 记忆相关 scopes（本次新增登记）

| scope | UI 名称（建议） | 默认 | 内容说明 | 备注 |
|---|---|---:|---|---|
| `memory` | 记忆 | 关（建议） | 有效记忆（本地小库/云端大库的“有效部分”） | 具体策略见 `docs/记忆存储与召回方案/记忆存储与召回方案.md` |
| `memory.trash` | 冗余记忆（回收站） | 关（默认关闭） | 记忆回收站（7 天内可找回） | 勾选且云端可用时：上传回收站记忆 + 墓碑，然后清空本地回收站（保留墓碑用于幂等） |

注意：
- 你要求“用户不做选择，自动化为主”，因此默认建议：`memory` 是否默认开启可以后续产品讨论；`memory.trash` 默认关闭不变。
- scope 只是开关键，不等于“实现已完成”。当前代码的记忆存储尚未完全对齐 Drift/同步体系，先以文档定义为准，后续再落实现。

---

## 5. 未来会扩展的 scopes（先占位，避免散落讨论）

后续每新增一项同步内容，请按本表补齐（scope + UI 名称 + 默认值 + 说明 + 备注），不要在接口里临时发明字符串。

建议方向（待定，先不写死 scope）：
- 设置类（非敏感/敏感分离）
- 用户手填文本/笔记
- 触发器/日程提醒
- 附件资源索引（图片/音频等，通常需要单独的资源同步策略）

---

## 6. 关联文档

- 云同步总施工手册：`apps/mygril_flutter/docs/备份与同步方案/施工手册_备份与云同步.md`
- 范围/回收站/分支策略：`apps/mygril_flutter/docs/备份与同步方案/云同步_范围回收站与分支策略.md`
- 记忆存储与召回：`apps/mygril_flutter/docs/记忆存储与召回方案/记忆存储与召回方案.md`
- 记忆重要性计算：`apps/mygril_flutter/docs/记忆存储与召回方案/记忆重要性计算.md`
