# MyGril 界面布局图（文本版）

本文档用文本字符绘制实际界面布局，方便快速理解各页面结构。

---

## 响应式布局说明

项目采用响应式设计，根据屏幕宽度自动切换：

- **窄屏模式**（宽度 < 900px）：单页面 + 底部导航栏
- **宽屏模式**（宽度 ≥ 900px）：左侧边栏（320px可调） + 右侧聊天内容

---

## 📱 窄屏模式

### 1. MainPage（主页容器）

```
┌─────────────────────────────────┐
│  角色 (3)                  [+]  │  ← AppBar (根据当前Tab显示不同标题)
├─────────────────────────────────┤
│                                 │
│  [当前Tab的内容区域]            │
│                                 │
│  根据底部导航切换显示:           │
│  - Tab 0: ContactsPage          │
│  - Tab 1: SettingsPage          │
│  - Tab 2: ProfilePage           │
│                                 │
│                                 │
│                                 │
├─────────────────────────────────┤
│  [💬] [⚙️] [👤]                 │  ← BottomNavigationBar (56dp)
│  消息   设置  我的              │
└─────────────────────────────────┘
```

**组件说明：**
- `MainPage`: 主容器，使用`IndexedStack`切换内容
- `BottomNavigationBar`: 3个Tab（消息/设置/我的）
- **背景色**: #F3F7F8（整体浅蓝灰色）

---

### 2. ContactsPage（联系人/消息页）

```
┌─────────────────────────────────┐
│  角色 (3)                  [+]  │  ← AppBar
├─────────────────────────────────┤
│  [🔍 请输入角色名...]     [✏️] │  ← SearchBar (40dp)
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────┐   │
│  │ [头像] Hina         [>] │   │  ← CharacterListItem
│  │       活跃 • 今天08:23  │   │     - avatarUrl (48dp圆形)
│  └─────────────────────────┘   │     - displayName
│                                 │     - 最后活跃时间
│  ┌─────────────────────────┐   │
│  │ [头像] Arona        [>] │   │  ← CharacterListItem
│  │       离线 • 昨天19:30  │   │
│  └─────────────────────────┘   │
│                                 │
│  ┌─────────────────────────┐   │
│  │ [头像] Shiroko      [>] │   │  ← CharacterListItem
│  │       活跃 • 刚刚       │   │
│  └─────────────────────────┘   │
│                                 │
│         ↓ 滚动查看更多 ↓        │
│                                 │
├─────────────────────────────────┤
│  [💬] [⚙️] [👤]                 │  ← BottomNavigationBar
│  消息   设置  我的              │
└─────────────────────────────────┘
```

**组件说明：**
- **AppBar**: 显示"角色 (数量)"和[+]新建按钮
- **SearchBar**: 搜索框，实时过滤角色列表
- **ContactsListContent**: 角色列表内容（可复用组件）
  - `CharacterListItem`: 单个角色卡片
  - 点击后跳转到`ChatPage`（窄屏）或更新选中状态（宽屏）

---

### 3. ChatPage（聊天页）

```
┌─────────────────────────────────┐
│  [<] Hina              [⋯]     │  ← AppBar
├─────────────────────────────────┤
│                                 │
│  ┌───────────────────┐          │
│  │ [头像] AI: 早安～  │          │  ← MessageBubble (左侧)
│  │        08:23      │          │     - 背景: #4C5B6F (深灰蓝)
│  └───────────────────┘          │     - 文字: 白色
│                                 │
│          ┌─────────────────┐    │
│          │ User: 早上好     │    │  ← MessageBubble (右侧)
│          │         08:25   │    │     - 背景: #8BBBE9 (主蓝色)
│          └─────────────────┘    │     - 文字: 白色
│                                 │
│  ┌─────────────────┐            │
│  │ [图片缩略图]     │            │  ← ImageMessage
│  │ 📷              │            │
│  └─────────────────┘            │
│                                 │
│        ↓ 下拉加载更多 ↓          │
│                                 │
├─────────────────────────────────┤
│ [模型▼] [输入框...] [📷] [▶]   │  ← Composer (56dp)
└─────────────────────────────────┘
```

**组件说明：**
- **AppBar**:
  - Leading: BackButton（返回主页）
  - Title: 角色名（如"Hina"）
  - Actions: [⋯] 更多按钮（打开ChatSettingsDialog）
- **MessageList** (消息列表区):
  - 背景色: 白色
  - `MessageBubble`: 消息气泡
    - AI消息: 左对齐，带头像，深灰蓝背景
    - 用户消息: 右对齐，无头像，蓝色背景
  - 时间戳: 小字体灰色
- **Composer** (输入栏):
  - 背景色: #F3F7F8
  - `DropdownButton`: 模型选择下拉框
  - `TextField`: 消息输入框
  - `IconButton`: 图片按钮
  - `IconButton`: 发送按钮

---

### 4. SettingsPage（设置页）

```
┌─────────────────────────────────┐
│  设置                           │  ← AppBar
├─────────────────────────────────┤
│                                 │
│  ┌─ 模型设置 ──────────────────┐│
│  │ [管理模型列表]              ││  ← OutlinedButton
│  │                             ││
│  │ 温度 0.70                   ││  ← Slider (0.0-1.0)
│  │ ─────●─────────             ││
│  │                             ││
│  │ 默认角色提示词              ││  ← TextField (多行)
│  │ [输入框................]    ││
│  └─────────────────────────────┘│
│                                 │
│  ┌─ 多模态设置 ────────────────┐│
│  │ 启用图像生成        [●─]   ││  ← SwitchListTile
│  │ AI可自行调用图像生成工具    ││
│  │                             ││
│  │ 文件上传限制 10 MB          ││  ← Slider (1-50MB)
│  │ ─────●─────────             ││
│  └─────────────────────────────┘│
│                                 │
│  ┌─ 多媒体设置 ────────────────┐│
│  │ 启用语音生成(TTS)   [●─]   ││  ← SwitchListTile
│  │ AI可自行调用语音工具        ││
│  └─────────────────────────────┘│
│                                 │
│  ┌─ 记忆设置 ──────────────────┐│
│  │ 对话历史保留 100条          ││  ← Slider (0-500)
│  │ ─────●─────────             ││
│  │ 0表示不限制，越多消耗越大   ││
│  │                             ││
│  │ [清空所有对话记录]          ││  ← OutlinedButton (红色)
│  └─────────────────────────────┘│
│                                 │
│  ┌─ 界面设置 ──────────────────┐│
│  │ (预留) 字体大小、主题切换   ││
│  │        敬请期待              ││
│  └─────────────────────────────┘│
│                                 │
│  ┌─ 关于 ──────────────────────┐│
│  │ [ℹ️] 应用版本   v1.0.0 Beta ││  ← ListTile
│  │ [📝] 开源协议   MIT License  ││  ← ListTile
│  │ [🐛] 反馈问题   点击反馈     ││  ← ListTile
│  └─────────────────────────────┘│
│                                 │
├─────────────────────────────────┤
│  [💬] [⚙️] [👤]                 │  ← BottomNavigationBar
│  消息   设置  我的              │
└─────────────────────────────────┘
```

**组件说明：**
- `SettingsContent`: 设置内容（可复用）
  - **模型设置区**:
    - 管理模型列表按钮（跳转ModelListPage）
    - 温度滑块（0.0-1.0，控制AI创造性）
    - 默认角色提示词（多行文本框）
  - **多模态设置区**:
    - 启用图像生成开关
    - 文件上传限制滑块（1-50MB）
  - **多媒体设置区**:
    - 启用语音生成（TTS）开关
  - **记忆设置区**:
    - 对话历史保留滑块（0-500条，0表示不限制）
    - 清空所有对话记录按钮（红色，有确认弹窗）
  - **界面设置区**: 预留功能
  - **关于区**:
    - 应用版本信息
    - 开源协议链接
    - 反馈问题链接

---

### 5. ProfilePage（我的/个人中心）

```
┌─────────────────────────────────┐
│  我的                           │  ← AppBar
├─────────────────────────────────┤
│                                 │
│                                 │
│                                 │
│           个人中心              │
│           敬请期待              │  ← ProfileContent (占位页面)
│                                 │
│                                 │
│                                 │
│                                 │
│                                 │
│                                 │
├─────────────────────────────────┤
│  [💬] [⚙️] [👤]                 │  ← BottomNavigationBar
│  消息   设置  我的              │
└─────────────────────────────────┘
```

**组件说明：**
- `ProfileContent`: 个人中心内容（可复用）
  - **当前状态**: 占位页面，显示"个人中心 敬请期待"
  - **未来规划**: 
    - 用户头像和基本信息
    - 个人资料编辑
    - 数据与存储管理
    - 通知设置
    - 账号管理（退出登录等）

---

### 6. ChatSettingsPage（聊天设置页）

**触发方式**: 在`ChatPage`的AppBar右上角点击[⋯]按钮，侧滑进入

```
┌─────────────────────────────────┐
│  [<] 聊天设置                    │  ← AppBar
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────────┐│
│  │ [头像]  Hina                ││  ← 角色信息展示区
│  │ 56x56   Schale学生会        ││     - 头像 (56dp圆形)
│  │                             ││     - 名称 + 组织
│  └─────────────────────────────┘│
│                                 │
├─────────────────────────────────┤  ← 分割线
│                                 │
│  [🔍] 查找聊天记录        [>]   │  ← ListTile
│                                 │
├─────────────────────────────────┤  ← 分割线
│                                 │
│  [✏️] 编辑角色信息        [>]   │  ← ListTile
│                                 │
├─────────────────────────────────┤  ← 分割线
│                                 │
│  [📌] 设为置顶            [●─]  │  ← SwitchTile
│                                 │
├─────────────────────────────────┤  ← 分割线
│                                 │
│  [🔕] 消息免打扰          [─●]  │  ← SwitchTile
│                                 │
├─────────────────────────────────┤  ← 分割线
│                                 │
│  [🔔] 消息提示音          [●─]  │  ← SwitchTile
│                                 │
├─────────────────────────────────┤  ← 分割线
│                                 │
│  [🗑️] 删除聊天记录        [>]    │  ← ListTile (橙色)
│       清空当前对话的所有消息      │     - 有二次确认弹窗
│                                 │
├─────────────────────────────────┤  ← 分割线
│                                 │
│  [❌] 删除角色            [>]   │  ← ListTile (红色)
│       删除该角色及其所有记录      │     - 有二次确认弹窗
│                                 │
└─────────────────────────────────┘
```

**组件说明：**
- **AppBar**: 
  - Leading: BackButton (返回聊天页)
  - Title: "聊天设置"
- **角色信息区域**:
  - 头像: 56dp圆形，支持网络图片
  - 名称: 16号字体，加粗
  - 组织: 13号字体，灰色
- **功能列表**:
  - `ListTile`: 普通功能项，右侧箭头
    - 查找聊天记录
    - 编辑角色信息
  - `SwitchTile`: 开关功能项
    - 设为置顶 (isPinned)
    - 消息免打扰 (isMuted)
    - 消息提示音 (notificationSound)
  - `ListTile`（危险操作）:
    - 删除聊天记录 - 橙色图标和文字
    - 删除角色 - 红色图标和文字
- **动画效果**:
  - 侧滑进入：从右侧滑入，250ms，easeOut曲线
  - 返回动画：从左侧滑出

**二次确认弹窗**:
```
┌─────────────────────────────────┐
│  删除聊天记录                    │  ← AlertDialog标题
├─────────────────────────────────┤
│                                 │
│  确定要删除所有聊天记录吗？       │
│  此操作不可撤销。                │
│                                 │
├─────────────────────────────────┤
│              [取消]  [删除]      │  ← 按钮
└─────────────────────────────────┘
```

---

## 🖥️ 宽屏模式

### SplitChatPage（双栏布局）

```
┌───────────────────┬─────────────────────────────────────────────────┐
│  角色 (3)    [+]  │  [☰] Hina                   [⋯]                │ ← 顶部栏 (58dp)
├───────────────────┼─────────────────────────────────────────────────┤
│ [🔍 搜索...]  [✏️] │                                               │
├───────────────────┤                                                │
│ ┌───────────────┐ │  ┌────────────────┐                            │
│ │[头像] Hina ✓ │ │  │[头像] AI: 早安～ │                            │
│ └───────────────┘ │  └────────────────┘                            │
│ ┌───────────────┐ │                  ┌──────────────────┐          │
│ │[头像] Arona  │ │                  │User: 早上好，Hina │          │
│ └───────────────┘ │                  └──────────────────┘          │
│ ┌───────────────┐ │                                                 │
│ │[头像] Shiroko│ │         [消息列表区域]                            │
│ └───────────────┘ │                                                 │
│       ⋮           │                                                 │
│                   │                                                 │
│                   │                                                 │
├───────────────────┼─────────────────────────────────────────────────┤
│ [💬] [⚙️] [👤]    │  [模型▼] [输入框.......] [📷] [▶]             │ ← 底部栏 (56dp)
└───────────────────┴─────────────────────────────────────────────────┘
    ↑ 左侧边栏          ↑ 分割线    ↑ 右侧聊天区
   (320px 可拖动)       (1px视觉   (自适应宽度)
   (200-600px)          8px热区)
```

### 左侧边栏详细结构

```
AnimatedContainer (宽度: 320px, 可折叠)
└─ Column
   ├─ Container (顶部导航栏, 58dp)
   │  └─ Row
   │     ├─ Text("角色 (3)" / "MyGril")  ← 根据Tab切换
   │     ├─ Spacer()
   │     └─ IconButton(Icons.add)  ← 仅在"消息"Tab显示
   │
   ├─ TextField (搜索框, 40dp)  ← 仅在"消息"Tab显示
   │  └─ 输入框 + 编辑图标
   │
   ├─ Expanded (内容区域, 自适应高度)
   │  └─ Container (背景: #F3F7F8)
   │     └─ IndexedStack (根据 _currentIndex 切换)
   │        ├─ [0] ContactsListContent  ← 角色列表
   │        │      └─ ListView
   │        │         └─ CharacterListItem (多个)
   │        │            - 点击更新 activeConversationId
   │        │            - 当前选中会话高亮显示
   │        │
   │        ├─ [1] SettingsContent  ← 设置内容
   │        │      └─ (同窄屏SettingsPage内容)
   │        │
   │        └─ [2] ProfileContent  ← 个人中心
   │               └─ (同窄屏ProfilePage内容)
   │
   └─ BottomNavigationBar (56dp)
      └─ 3个Tab: 消息/设置/我的
```

### 右侧聊天区结构

```
Expanded (自适应宽度)
└─ ChatPage(showToggleButton: true)
   └─ Scaffold
      ├─ AppBar (58dp)
      │  ├─ Leading: IconButton([☰]) ← 折叠/展开侧边栏
      │  ├─ Title: Text("Hina")
      │  └─ Actions: IconButton([⋯]) ← 更多按钮
      │
      ├─ Expanded (消息列表区)
      │  └─ Container (背景: 白色)
      │     └─ ListView
      │        └─ MessageBubble (多个)
      │
      └─ Composer (56dp)
         └─ Row
            ├─ DropdownButton (模型选择)
            ├─ TextField (消息输入)
            ├─ IconButton (图片)
            └─ IconButton (发送)
```

### 分割线与拖动

```
Positioned (叠加层)
└─ MouseRegion (cursor: resizeColumn)
   └─ GestureDetector (onHorizontalDragUpdate)
      └─ Container (视觉分割线)
         - 位置: left = sidebarWidth - 4
         - 热区宽度: 8px
         - 视觉线宽: 1px (borderWidth)
         - 颜色: moeDividerColor
         - 拖动范围: 200-600px
```

---

## 🎨 设计规范

### 尺寸常量（来自 tokens.dart）

| 常量名 | 值 | 说明 |
|--------|-----|------|
| `bottomBarHeight` | 56.0 | 底部导航栏/输入框高度 |
| `borderWidth` | 2.0 | 边框/分割线宽度 |
| AppBar高度 | 56dp + 2dp | 内容高度 + 底部分割线 |

### 颜色常量（来自 tokens.dart）

| 常量名 | 颜色值 | 用途 |
|--------|--------|------|
| `moePrimary` | #8BBBE9 | 主色调（蓝色） |
| `moeSurface` | #F3F6F8 | 表面背景色 |
| `moePanel` | #DAE5F1 | 容器背景 |
| `moeText` | #222529 | 主文本颜色 |
| `moeTextSecondary` | - | 次要文本颜色 |
| `moeMuted` | - | 弱化文本颜色 |
| `moeDividerColor` | - | 分割线颜色 |
| `moeBorderLight` | #E6E9EB | 淡色边框 |
| AI消息气泡背景 | #4C5B6F | 深灰蓝 |
| 用户消息气泡背景 | #8BBBE9 | 主蓝色 |
| 消息列表背景 | #FFFFFF | 纯白色 |
| 左侧边栏背景 | #F3F7F8 | 浅蓝灰色 |

---

## 🧩 核心组件架构（DRY原则）

### 可复用内容组件（无AppBar）

```
ContactsListContent  ←──┬─ 被 ContactsPage 使用（窄屏）
                        └─ 被 SplitChatPage 使用（宽屏左侧）

SettingsContent      ←──┬─ 被 SettingsPage 使用（窄屏）
                        └─ 被 SplitChatPage 使用（宽屏左侧）

ProfileContent       ←──┬─ 被 ProfilePage 使用（窄屏）
                        └─ 被 SplitChatPage 使用（宽屏左侧）
```

### 完整页面组件（带AppBar）

```
MainPage           = IndexedStack + BottomNavigationBar
                     └─ 包含 ContactsPage / SettingsPage / ProfilePage

ContactsPage       = AppBar + ContactsListContent + BottomNavigationBar
SettingsPage       = AppBar + SettingsContent + BottomNavigationBar
ProfilePage        = AppBar + ProfileContent + BottomNavigationBar

ChatPage           = AppBar + MessageList + Composer
                     ├─ showToggleButton: 控制是否显示侧边栏折叠按钮
                     └─ AppBar右上角[⋯]按钮 → showChatSettingsDialog() → ChatSettingsPage

ChatSettingsPage   = AppBar + 角色信息展示 + ListView (功能列表)
                     └─ 侧滑动画进入（250ms）

SplitChatPage      = Row
                     ├─ AnimatedContainer (左侧边栏)
                     │  └─ Column
                     │     ├─ 自定义顶部导航
                     │     ├─ 搜索框（可选）
                     │     ├─ IndexedStack (3个Tab内容)
                     │     └─ BottomNavigationBar
                     └─ ChatPage(showToggleButton: true)
```

---

## 🔄 路由逻辑（GoRouter）

```dart
routes:
  /                         → 根据屏幕宽度自动选择
    - 宽度 < 900px          → MainPage（窄屏）
    - 宽度 ≥ 900px          → SplitChatPage（宽屏）

  /chat/:id                 → ChatPage（全屏，窄屏使用）
    - 点击联系人后跳转
    - 显示完整的聊天界面
```

**说明：**
- 宽屏模式下，点击联系人**不跳转路由**，只更新`activeConversationIdProvider`状态
- 窄屏模式下，点击联系人跳转到`/chat/:id`路由

---

## 📂 关键文件位置

| 组件 | 文件路径 | 说明 |
|------|---------|------|
| **MainPage** | `pages/main_page.dart` | 窄屏主容器 |
| **SplitChatPage** | `pages/split_chat_page.dart` | 宽屏双栏布局 |
| **ChatPage** | `pages/chat_page.dart` | 聊天页面 |
| **ChatSettingsPage** | `widgets/chat_settings_dialog.dart` | 聊天设置页（侧滑弹出） |
| **ContactsPage** | `pages/contacts_page.dart` | 联系人页面（窄屏） |
| **SettingsPage** | `pages/settings_page.dart` | 设置页面（窄屏） |
| **ProfilePage** | `pages/profile_page.dart` | 个人中心页面（窄屏） |
| **ContactsListContent** | `widgets/contacts_list_content.dart` | 联系人列表（可复用） |
| **SettingsContent** | `pages/settings_page.dart` | 设置内容（内嵌在SettingsPage） |
| **ProfileContent** | `widgets/profile_content.dart` | 个人中心内容（可复用） |
| **Composer** | `widgets/composer.dart` | 输入框组件 |
| **MessageBubble** | `widgets/message_bubble.dart` | 消息气泡 |
| **CharacterListItem** | `widgets/character_list_item.dart` | 角色列表项 |
| **ChatSettingsDialog** | `widgets/chat_settings_dialog.dart` | 聊天设置弹窗 |

---

## 🎯 交互说明

### 窄屏交互流程

1. **启动应用** → `MainPage` → 默认显示`ContactsPage`（消息Tab）
2. **点击底部导航** → 切换Tab（消息/设置/我的）
3. **点击联系人** → 跳转到`/chat/:id` → 显示`ChatPage`
4. **点击[⋯]按钮** → 侧滑弹出`ChatSettingsPage` → 查看/修改聊天设置
5. **点击返回按钮** → 返回`MainPage`或上一页

### 宽屏交互流程

1. **启动应用** → `SplitChatPage` → 左侧显示联系人列表 + 右侧显示聊天页
2. **点击左侧联系人** → 更新`activeConversationIdProvider` → 右侧`ChatPage`自动刷新
3. **点击右上角[⋯]按钮** → 侧滑弹出`ChatSettingsPage` → 查看/修改聊天设置
4. **点击底部导航** → 左侧内容切换（消息/设置/我的）
5. **点击[☰]按钮** → 折叠/展开左侧边栏
6. **拖动分割线** → 调整左侧边栏宽度（200-600px）

---

## ✅ 重要特性

### 1. 响应式布局
- 使用`LayoutBuilder`和`MediaQuery`检测屏幕宽度
- 断点：900px
- 自动切换窄屏/宽屏模式

### 2. 组件复用（DRY原则）
- `ContactsListContent`、`SettingsContent`、`ProfileContent`在窄屏和宽屏中复用
- 减少约240行重复代码

### 3. 状态管理（Riverpod）
- `activeConversationIdProvider`: 当前活跃会话ID
- `conversationsProvider`: 会话列表
- `sidebarVisibleProvider`: 侧边栏显示状态
- `sendingProvider`: 消息发送中状态

### 4. 动画效果
- 侧边栏折叠/展开：250ms，easeInOut曲线
- 宽度调整：实时拖动，无延迟

---

**文档版本**: v1.0
**创建日期**: 2025-10-24
**维护者**: Claude Code Assistant
**基于代码版本**: 截至 2025-10-24 的实际实现
